<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Data Form</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a better look and feel */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        .form-section {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .form-section h2 {
            font-size: 1.5rem;
            font-weight: 2000;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            color: #111827;
        }
        label {
            font-weight: 500;
            color: #374151;
        }
        .required-asterisk {
            color: #ef4444;
            margin-left: 0.25em;
            font-size: 1em;
            font-weight: bold;
        }
        .dropdown-padding {
            padding: 0.75rem 1rem;
        }
        input[type="text"], input[type="email"], input[type="date"], input[type="number"], input[type="tel"], select {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            height: 3.2rem;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .main-tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .main-tab-button.active {
            background-color: #3b82f6 !important;
            color: white !important;
            border: 2px solid #2563eb !important;
        }
        .main-tab-button:not(.active) {
            background-color: #e5e7eb !important;
            color: #374151 !important;
            border: 2px solid transparent !important;
        }
        .form-tab-button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        .form-tab-button.active {
             border-color: #3b82f6;
             color: #3b82f6;
        }
        /* Modal and Loader Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 95%;
            max-width: 1000px; /* wider for details view */
            max-height: 93vh;
            overflow-y: auto;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            display: block;
            min-height: 1rem; /* Reserve space to prevent layout shift */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Form View -->
        <div id="form-view">
            <div class="max-w-4xl mx-auto">
                <!-- Header container with relative positioning -->
                <div class="relative flex justify-center items-center mb-8">
                    <div class="absolute left-0"><img src="data:image/png;base64, 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" alt="Company Logo" class="h-16"></div>
                    <h1 class="text-3xl font-bold text-gray-800">Data Sheet</h1>
                    <div class="absolute right-0 text-right">
                        <h2 class="text-xl font-bold text-gray-800">Rapolu Venkateshwarlu</h2>
                        <p class="text-sm text-gray-600">Insurance Advisor</p>
                    </div>
                </div>

                    <!-- Main Tab Navigation -->
                <div class="flex justify-center space-x-4 mb-8">
                    <button id="form-tab-button" class="main-tab-button active" onclick="showMainTab('form-view')">Data Entry Form</button>
                    <button id="view-tab-button" class="main-tab-button" onclick="showMainTab('data-view')">View Submitted Data</button>
                </div>

                <!-- Progress Indicator -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Form Progress</span>
                        <span id="progress-text">1 of 7</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 14.29%"></div>
                    </div>
                </div>

                <!-- Form Tab Navigation -->
                <div id="form-tabs-nav" class="flex border-b border-gray-200 mb-6 overflow-x-auto">
                    <!-- Tabs will be generated here by JS -->
                </div>
                <form id="data-form">
                    <!-- Applicant Details -->
                    <div class="form-section form-tab-panel" data-tab-name="Applicant">
                        <h2>Applicant Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="name_of_la">Name of Life Assured <span class="required-asterisk">*</span></label><input type="text" id="name_of_la" name="name_of_la" class="mt-1" required><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="proposer">Proposer Name</label><input type="text" id="proposer" name="proposer" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="aadhaar">Aadhaar <span class="required-asterisk">*</span></label><input type="text" id="aadhaar" name="aadhaar" class="mt-1" required><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="ckyc">CKYC</label><input type="text" id="ckyc" name="ckyc" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="abha">ABHA</label><input type="text" id="abha" name="abha" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="pan">PAN</label><input type="text" id="pan" name="pan" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="f_name">Father's Name</label><input type="text" id="f_name" name="f_name" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="m_name">Mother's Name</label><input type="text" id="m_name" name="m_name" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div>
                                <label for="gender">Gender <span class="required-asterisk">*</span></label>
                                <select id="gender" name="gender" class="mt-1 dropdown-padding" required>
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Trans">Trans</option>
                                </select>
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                            <div>
                                <label for="is_married">Is Married <span class="required-asterisk">*</span></label>
                                <select id="is_married" name="is_married" class="mt-1 dropdown-padding" aria-label="Is Married" required>
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                            <div class="marriage-dependent hidden"><label for="spouse">Spouse's Name <span class="required-asterisk">*</span></label><input type="text" id="spouse" name="spouse" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div class="marriage-dependent hidden"><label for="d_marriage">Date of Marriage <span class="required-asterisk">*</span></label><input type="date" id="d_marriage" name="d_marriage" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            
                        </div>
                        <div class="flex justify-end mt-6"><button type="button" onclick="navigateFormTab(1)" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next &rarr;</button></div>
                    </div>
                    
                    <!-- Contact Details -->
                    <div class="form-section form-tab-panel hidden" data-tab-name="Contact">
                        <h2>Contact & Personal Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="mobile_adhar">Mobile (Aadhaar) <span class="required-asterisk">*</span></label><input type="tel" id="mobile_adhar" name="mobile_adhar" class="mt-1" pattern="\d{10}" title="Please enter a 10-digit mobile number" required><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="mobile">Mobile </label><input type="tel" id="mobile" name="mobile" class="mt-1" pattern="\d{10}" title="Please enter a 10-digit mobile number"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="email">E-mail </label><input type="email" id="email" name="email" class="mt-1" ><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="whatsapp">Whatsapp</label><input type="tel" id="whatsapp" name="whatsapp" class="mt-1" pattern="\d{10}"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="dob">DOB <span class="required-asterisk">*</span></label><input type="date" id="dob" name="dob" class="mt-1" required><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="birth_place">Birth Place</label><input type="text" id="birth_place" name="birth_place" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="near_lb_age">Age</label><input type="text" id="near_lb_age" name="near_lb_age" class="mt-1" readonly placeholder="Calculated from DOB"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div>
                                <label for="residential_status">Residential Status</label>
                                <select id="residential_status" name="residential_status" class="mt-1 dropdown-padding" style="height: 3rem;">
                                    <option value="">Select</option>
                                    <option value="Resident Indian">Resident Indian</option>
                                    <option value="NRI">NRI</option>
                                    <option value="FNIO">FNIO</option>
                                </select>
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                                                    <div class="md:col-span-2 hidden" id="corr-address-container"><label for="corr_address">Correspondence Address</label><input type="text" id="corr_address" name="corr_address" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                <div class="md:col-span-2"><label for="address">Address as per KYC</label><input type="text" id="address" name="address" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                                    <div class="md:col-span-2 flex items-center space-x-3">
                                                        <input type="checkbox" id="corr_same_kyc" name="corr_same_kyc" class="mt-1">
                                                        <label for="corr_same_kyc" class="mb-0">Is the correspondence address same as KYC?</label>
                                                    </div>
                        </div>
                        <div class="flex justify-between mt-6"><button type="button" onclick="navigateFormTab(-1)" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">&larr; Previous</button><button type="button" onclick="navigateFormTab(1)" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next &rarr;</button></div>
                    </div>

                    <!-- Education & Qualification -->
                    <div class="form-section form-tab-panel hidden" data-tab-name="Education & Qualification">
                        <h2>Education & Qualification Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label for="education">Education</label><input type="text" id="education" name="education" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="current_job">Current Job</label><input type="text" id="current_job" name="current_job" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="type_of_duty">Type of Duty</label><input type="text" id="type_of_duty" name="type_of_duty" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="co_name">Company Name</label><input type="text" id="co_name" name="co_name" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="since">Since</label><input type="text" id="since" name="since" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="total_experience">Total Experience</label><input type="text" id="total_experience" name="total_experience" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="a_income">₹ Annual Income</label><input type="text" inputmode="numeric" id="a_income" name="a_income" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="ly_income1">₹ LY Income 1</label><input type="text" inputmode="numeric" id="ly_income1" name="ly_income1" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="ly_income2">₹ LY Income 2</label><input type="text" inputmode="numeric" id="ly_income2" name="ly_income2" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="ly_income3">₹ LY Income 3</label><input type="text" inputmode="numeric" id="ly_income3" name="ly_income3" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <!-- Husband details: shown when Gender is Female -->
                            <div id="husband-details-section" class="hidden md:col-span-2 lg:col-span-3 form-section bg-gray-50 p-4 rounded">
                                <h3 class="font-semibold mb-3">Husband Details</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="husband_occupation">Occupation</label><input type="text" id="husband_occupation" name="husband_occupation" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                    <div><label for="husband_annual_income">₹ Annual Income</label><input type="text" inputmode="numeric" id="husband_annual_income" name="husband_annual_income" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between mt-6"><button type="button" onclick="navigateFormTab(-1)" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">&larr; Previous</button><button type="button" onclick="navigateFormTab(1)" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next &rarr;</button></div>
                    </div>

                    <!-- Plan Details -->
                    <div class="form-section form-tab-panel hidden" data-tab-name="Proposed Plan">
                        <h2>Proposed Plan</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                            <div><label for="plan_term">PLAN / Term <span class="required-asterisk">*</span></label><input type="text" id="plan_term" name="plan_term" class="mt-1" required><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="ppt">PPT</label><input type="text" id="ppt" name="ppt" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div>
                                <label for="mode">Mode</label>
                                <select id="mode" name="mode" class="mt-1 dropdown-padding" style="height: 3rem;">
                                    <option value="">Select</option>
                                    <option value="Yearly">Yearly</option>
                                    <option value="Half Yearly">Half Yearly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="NACH">NACH</option>
                                    <option value="Single">Single</option>
                                </select>
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                            <div><label for="sum_assured">Sum Assured</label><input type="number" id="sum_assured" min="0" name="sum_assured" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div>
                                <label for="ab_addb">Accidental Benefit</label>
                                <select id="ab_addb" name="ab_addb" class="mt-1 dropdown-padding" style="height: 3rem;">
                                    <option value="">Select</option>
                                    <option value="AB">AB</option>
                                    <option value="ADDB">ADDB</option>
                                </select>
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                            <div>
                                <label for="term_rider">Term Rider</label>
                                <select id="term_rider" name="term_rider" class="mt-1 dropdown-padding" style="height: 3rem;">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                            <div><label for="premium">Premium <span class="required-asterisk">*</span></label><input type="number" id="premium" min="0" name="premium" class="mt-1" required><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div>
                                <label for="dating_back">Dating Back</label>
                                <select id="dating_back" name="dating_back" class="mt-1 dropdown-padding" style="height: 3rem;">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                            <div id="dating-back-date-container" class="hidden">
                                <label for="dating_back_date">Dating Back Date</label>
                                <input type="date" id="dating_back_date" name="dating_back_date" class="mt-1">
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                            <div>
                                <label for="pwb">PWB</label>
                                <select id="pwb" name="pwb" class="mt-1 dropdown-padding" style="height: 3rem;">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                                <span class="error-message text-red-500 text-sm mt-1"></span>
                            </div>
                            <div><label for="boc_number">BOC Number</label><input type="text" id="boc_number" name="boc_number" class="mt-1" placeholder="Enter BOC number"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="boc_date">BOC Date</label><input type="date" id="boc_date" name="boc_date" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="boc_amt">BOC Amt</label><input type="number" id="boc_amt" min="0" name="boc_amt" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="doc">DOC</label><input type="date" id="doc" name="doc" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="policy_no">Policy No</label><input type="text" id="policy_no" name="policy_no" class="mt-1" placeholder="Enter Policy number"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                        </div>
                         <div class="flex justify-between mt-6"><button type="button" onclick="navigateFormTab(-1)" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">&larr; Previous</button><button type="button" onclick="navigateFormTab(1)" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next &rarr;</button></div>
                    </div>
                    
                    <!-- Nominee Details -->
                    <div class="form-section form-tab-panel hidden" data-tab-name="Nominee">
                        <h2>Nominee & Appointee Details</h2>
                        <div class="mb-4 form-section bg-gray-50 p-4 rounded">
                            <h3 class="font-semibold mb-3">Nominees</h3>
                            <div id="nominees-repeater" class="space-y-3">
                                <!-- nominee items injected here -->
                            </div>
                            <template id="nominee-template">
                                <div class="nominee-item relative grid grid-cols-1 md:grid-cols-6 gap-3 p-3 rounded border border-gray-200 bg-white items-end">
                                    <button type="button" class="remove-nominee absolute top-2 right-2 text-gray-500 hover:text-gray-800 bg-transparent p-1 rounded" aria-label="Remove nominee">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                    <div class="md:col-span-2"><label class="text-xs text-gray-600">Name</label><input type="text" name="nominee_name" class="mt-1 nominee-name"></div>
                                    <div><label class="text-xs text-gray-600">Share %</label><input type="number" min="0" max="100" step="0.01" name="nominee_share" class="mt-1 nominee-share"></div>
                                    <div><label class="text-xs text-gray-600">Date of Birth</label><input type="date" name="nominee_dob" class="mt-1 nominee-dob"></div>
                                    <div><label class="text-xs text-gray-600">Relation</label><input type="text" name="nominee_relation" class="mt-1 nominee-relation"></div>
                                    <div><label class="text-xs text-gray-600">Aadhaar</label><input type="text" name="nominee_aadhaar" class="mt-1 nominee-aadhaar"></div>
                                </div>
                            </template>
                            <div class="mt-3">
                                <button type="button" id="add-nominee" class="bg-blue-600 text-white font-bold py-2 px-4 rounded">Add Nominee</button>
                            </div>
                            <div id="nominee-error" class="text-sm text-red-600 mt-2"></div>
                        </div>
                        <hr class="my-6 border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label for="appointee">Appointee</label><input type="text" id="appointee" name="appointee" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="appointee_relation">Relation</label><input type="text" id="appointee_relation" name="appointee_relation" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="appointee_age">Age</label><input type="number" id="appointee_age" name="appointee_age" min="0" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                        </div>
                        <div class="flex justify-between mt-6"><button type="button" onclick="navigateFormTab(-1)" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">&larr; Previous</button><button type="button" onclick="navigateFormTab(1)" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next &rarr;</button></div>
                    </div>

                    <!-- Bank Details -->
                    <div class="form-section form-tab-panel hidden" data-tab-name="Bank">
                        <h2>Bank Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="bank_name">Bank Name</label><input type="text" id="bank_name" name="bank_name" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="ac_type">A/c Type</label><input type="text" id="ac_type" name="ac_type" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div class="md:col-span-2"><label for="ac_holder_name">A/c Holder's Name</label><input type="text" id="ac_holder_name" name="ac_holder_name" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div class="md:col-span-2"><label for="bank_address">Address</label><input type="text" id="bank_address" name="bank_address" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="ac_no">A/C No.</label><input type="text" id="ac_no" name="ac_no" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="micr_code">MICR Code</label><input type="text" id="micr_code" name="micr_code" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                            <div><label for="ifsc_code">IFSC Code</label><input type="text" id="ifsc_code" name="ifsc_code" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                        </div>
                        <div class="flex justify-between mt-6"><button type="button" onclick="navigateFormTab(-1)" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">&larr; Previous</button><button type="button" onclick="navigateFormTab(1)" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next &rarr;</button></div>
                    </div>
                    
                    <!-- Medical Details -->
                    <div class="form-section form-tab-panel hidden" data-tab-name="Medical History">
                        <h2>Family & Medical Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <h3 class="font-semibold text-lg mb-2">Father's Details</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="fam_father_age">Age</label><input type="number" id="fam_father_age" min="0" name="fam_father_age" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                    <div>
                                        <label for="fam_father_state">State of Health</label>
                                        <select id="fam_father_state" name="fam_father_state" class="mt-1 dropdown-padding" style="height:3rem;">
                                            <option value="">Select</option>
                                            <option value="Good">Good</option>
                                            <option value="Dead">Dead</option>
                                        </select>
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <div id="father-death-container" class="md:col-span-2 hidden">
                                        <div class="grid grid-cols-3 gap-4">
                                            <div><label for="fam_father_died_age">Age at Death</label><input type="number" min="0" id="fam_father_died_age" name="fam_father_died_age" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                            <div><label for="fam_father_died_year">Death Year</label><input type="number" min="0" id="fam_father_died_year" name="fam_father_died_year" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                            <div><label for="fam_father_died_cause">Cause of Death</label><input type="text" id="fam_father_died_cause" name="fam_father_died_cause" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg mb-2">Mother's Details</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="fam_mother_age">Age</label><input type="number" id="fam_mother_age" min="0" name="fam_mother_age" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                    <div>
                                        <label for="fam_mother_state">State of Health</label>
                                        <select id="fam_mother_state" name="fam_mother_state" class="mt-1 dropdown-padding" style="height:3rem;">
                                            <option value="">Select</option>
                                            <option value="Good">Good</option>
                                            <option value="Dead">Dead</option>
                                        </select>
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <div id="mother-death-container" class="md:col-span-2 hidden">
                                        <div class="grid grid-cols-3 gap-4">
                                            <div><label for="fam_mother_died_age">Age at Death</label><input type="number" min="0" id="fam_mother_died_age" name="fam_mother_died_age" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                            <div><label for="fam_mother_died_year">Death Year</label><input type="number" min="0" id="fam_mother_died_year" name="fam_mother_died_year" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                            <div><label for="fam_mother_died_cause">Cause of Death</label><input type="text" id="fam_mother_died_cause" name="fam_mother_died_cause" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold text-lg mb-2">Spouse Details</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="fam_spouse_age">Age</label><input type="number" id="fam_spouse_age" min="0" name="fam_spouse_age" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                    <div>
                                        <label for="fam_spouse_state">State of Health</label>
                                        <select id="fam_spouse_state" name="fam_spouse_state" class="mt-1 dropdown-padding" style="height:3rem;">
                                            <option value="">Select</option>
                                            <option value="Good">Good</option>
                                            <option value="Dead">Dead</option>
                                        </select>
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <div id="spouse-death-container" class="md:col-span-2 hidden">
                                        <div class="grid grid-cols-3 gap-4">
                                            <div><label for="fam_spouse_died_age">Age at Death</label><input type="number" min="0" id="fam_spouse_died_age" name="fam_spouse_died_age" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                            <div><label for="fam_spouse_died_year">Death Year</label><input type="number" min="0" id="fam_spouse_died_year" name="fam_spouse_died_year" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                            <div><label for="fam_spouse_died_cause">Cause of Death</label><input type="text" id="fam_spouse_died_cause" name="fam_spouse_died_cause" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="md:col-span-2 mt-4">
                                <h3 class="font-semibold text-lg mb-2">Siblings & Children</h3>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label for="num_brothers">Number of Brothers</label>
                                        <input type="number" id="num_brothers" name="num_brothers" min="0" class="mt-1" value="0">
                                    </div>
                                    <div>
                                        <label for="num_sisters">Number of Sisters</label>
                                        <input type="number" id="num_sisters" name="num_sisters" min="0" class="mt-1" value="0">
                                    </div>
                                    <div>
                                        <label for="num_children">Number of Children</label>
                                        <input type="number" id="num_children" name="num_children" min="0" class="mt-1" value="0">
                                    </div>
                                </div>

                                <div id="brothers-repeater" class="mt-4 space-y-3"></div>
                                <div id="sisters-repeater" class="mt-4 space-y-3"></div>
                                <div id="children-repeater" class="mt-4 space-y-3"></div>
                            </div>
                            <div class="md:col-span-2 mt-4">
                                <h3 class="font-semibold text-lg mb-2">Medical Details</h3>
                                <div class="grid grid-cols-3 gap-4">
                                    <div><label for="height">Height (Cm)</label><input type="number" id="height" min="0" name="height" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                    <div><label for="weight">Weight (Kg)</label><input type="number" id="weight" min="0" name="weight" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                    <div><label for="abd">Abd (Cm)</label><input type="number" id="abd" min="0" name="abd" class="mt-1"><span class="error-message text-red-500 text-sm mt-1"></span></div>
                                    <div>
                                        <label for="any_operations">Any Operations?</label>
                                        <select id="any_operations" name="any_operations" class="mt-1 dropdown-padding" style="height:3rem;">
                                            <option value="">Select</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <div id="operation-details-container" class="hidden md:col-span-2">
                                        <label for="operation_details">Operation details</label>
                                        <input type="text" id="operation_details" name="operation_details" class="mt-1">
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <div>
                                        <label for="any_diseases">Any Diseases?</label>
                                        <select id="any_diseases" name="any_diseases" class="mt-1 dropdown-padding" style="height:3rem;">
                                            <option value="">Select</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <div id="disease-details-container" class="hidden md:col-span-2">
                                        <label for="disease_details">Disease details</label>
                                        <input type="text" id="disease_details" name="disease_details" class="mt-1">
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <!-- Pregnancy fields: shown only when Gender === 'Female' -->
                                    <div id="pregnancy-section" class="hidden md:col-span-1">
                                        <label for="are_pregnant">Are you pregnant?</label>
                                        <select id="are_pregnant" name="are_pregnant" class="mt-1 dropdown-padding" style="height:3rem;">
                                            <option value="">Select</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <div id="last-delivery-container" class="hidden md:col-span-1">
                                        <label for="last_delivery_date">Date of last delivery</label>
                                        <input type="date" id="last_delivery_date" name="last_delivery_date" class="mt-1">
                                        <span class="error-message text-red-500 text-sm mt-1"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between mt-6"><button type="button" onclick="navigateFormTab(-1)" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">&larr; Previous</button><button type="button" onclick="navigateFormTab(1)" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next &rarr;</button></div>
                    
                        </div>
                    
                    <!-- Previous Policy Details -->
                    <div class="form-section form-tab-panel hidden" data-tab-name="Previous Policy">
                        <h2>Previous Policy Details</h2>
                        <div class="text-sm text-gray-600 mb-4">Click the "Add Previous Policy" button below to add one or more previous policies.</div>
                        <!-- Multi previous policies repeater (keeps the legacy single fields above) -->
                        <div class="mt-6 form-section bg-gray-50 p-4 rounded">
                            <div id="previous-policies-repeater" class="space-y-3">
                                <!-- items injected here -->
                            </div>
                            <template id="previous-policy-template">
                                <div class="previous-policy-item relative grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3 p-3 rounded border border-gray-200 bg-white">
                                    <div><label class="text-xs text-gray-600">Policy Number</label><input type="text" class="mt-1 prev-field prev-policy-no"></div>
                                    <div><label class="text-xs text-gray-600">Branch</label><input type="text" class="mt-1 prev-field prev-branch"></div>
                                    <div><label class="text-xs text-gray-600">Plan/Term</label><input type="text" class="mt-1 prev-field prev-plan-term"></div>
                                    <div><label class="text-xs text-gray-600">Sum Assured</label><input type="text" class="mt-1 prev-field prev-sa"></div>
                                    <div><label class="text-xs text-gray-600">Premium</label><input type="text" class="mt-1 prev-field prev-y-premium"></div>
                                    <div><label class="text-xs text-gray-600">Mode</label>
                                        <select class="mt-1 prev-field prev-mode dropdown-padding" name="prev_mode" style="height: 3.2rem;">
                                            <option value="">Select</option>
                                            <option value="Yearly">Yearly</option>
                                            <option value="Half Yearly">Half Yearly</option>
                                            <option value="Quarterly">Quarterly</option>
                                            <option value="NACH">NACH</option>
                                            <option value="Single">Single</option>
                                        </select>
                                    </div>
                                    <div><label class="text-xs text-gray-600">Accidental Benefit</label>
                                        <select class="mt-1 prev-field prev-ab-addb dropdown-padding" name="prev_ab_addb" style="height: 3.2rem;">
                                            <option value="">Select</option>
                                            <option value="AB">AB</option>
                                            <option value="ADDB">ADDB</option>
                                        </select>
                                    </div>
                                    <div><label class="text-xs text-gray-600">Date of Commencement</label><input type="date" class="mt-1 prev-field prev-doc"></div>
                                    <div><label class="text-xs text-gray-600">Rate Accepted</label>
                                        <select class="mt-1 prev-field prev-or dropdown-padding" name="prev_or" style="height: 3.2rem;">
                                            <option value="">Select</option>
                                            <option value="Ordinary Rate">Ordinary Rate</option>
                                            <option value="Special Rate">Special Rate</option>
                                        </select>
                                    </div>
                                    <div><label class="text-xs text-gray-600">Medical</label>
                                        <select class="mt-1 prev-field prev-m-nm dropdown-padding" name="prev_m_nm" style="height: 3.2rem;">
                                            <option value="">Select</option>
                                            <option value="Medical">Medical</option>
                                            <option value="Non-Medical">Non-Medical</option>
                                        </select>
                                    </div>
                                    <div><label class="text-xs text-gray-600">Inforce</label>
                                        <select class="mt-1 prev-field prev-inforce dropdown-padding" name="prev_inforce" style="height: 3.2rem;">
                                            <option value="">Select</option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                    </div>
                                    <button type="button" class="remove-previous-policy absolute top-2 right-2 text-gray-500 hover:text-gray-800 bg-transparent p-1 rounded" aria-label="Remove previous policy">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                </div>
                            </template>
            
                    <!-- Templates for dynamic sibling/child entries -->
                    <template id="sibling-template">
                    <div class="sibling-item relative grid grid-cols-1 md:grid-cols-6 gap-3 p-3 rounded border border-gray-200 bg-white items-end">
                        <button type="button" class="remove-sibling absolute top-2 right-2 text-gray-500 hover:text-gray-800 bg-transparent p-1 rounded" aria-label="Remove sibling">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                        <div class="md:col-span-6"><div class="text-sm font-medium sibling-header text-gray-700 mb-2">Sibling</div></div>
                            <div><label class="text-xs text-gray-600">Age</label><input type="number" min="0" class="mt-1 sibling-age"></div>
                            <div><label class="text-xs text-gray-600">State</label>
                                <select class="mt-1 sibling-state dropdown-padding" style="height:3rem;"><option value="">Select</option><option value="Good">Good</option><option value="Dead">Dead</option></select>
                            </div>
                            <div class="sibling-death-container md:col-span-3 hidden">
                                <div class="grid grid-cols-3 gap-2 md:gap-4 w-full">
                                    <div><label class="text-xs text-gray-600">Age at Death</label><input type="text" class="mt-1 sibling-died-age" ></div>
                                    <div><label class="text-xs text-gray-600">Death Year</label><input type="text" class="mt-1 sibling-died-year" ></div>
                                    <div><label class="text-xs text-gray-600">Cause of Death</label><input type="text" class="mt-1 sibling-died-cause" ></div>
                                </div>
                            </div>
                    </div>
                    </template>

                    <template id="child-template">
                    <div class="child-item relative grid grid-cols-1 md:grid-cols-6 gap-3 p-3 rounded border border-gray-200 bg-white items-end">
                        <button type="button" class="remove-child absolute top-2 right-2 text-gray-500 hover:text-gray-800 bg-transparent p-1 rounded" aria-label="Remove child">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                        <div class="md:col-span-6"><div class="text-sm font-medium child-header text-gray-700 mb-2">Child</div></div>
                                    <div><label class="text-xs text-gray-600">Age</label><input type="number" min="0" class="mt-1 child-age"></div>
                                    <div><label class="text-xs text-gray-600">State</label>
                                        <select class="mt-1 child-state dropdown-padding" style="height:3rem;"><option value="">Select</option><option value="Good">Good</option><option value="Dead">Dead</option></select>
                                    </div>
                                    <div class="child-death-container md:col-span-3 hidden">
                                        <div class="grid grid-cols-3 gap-2 md:gap-4 w-full">
                                            <div><label class="text-xs text-gray-600">Age at Death</label><input type="text" class="mt-1 child-died-age" ></div>
                                            <div><label class="text-xs text-gray-600">Death Year</label><input type="text" class="mt-1 child-died-year" ></div>
                                            <div><label class="text-xs text-gray-600">Cause of Death</label><input type="text" class="mt-1 child-died-cause" ></div>
                                        </div>
                                    </div>
                        
                                </div>
                            </template>
                            <div class="mt-3">
                                <button type="button" id="add-previous-policy" class="bg-blue-600 text-white font-bold py-2 px-4 rounded">Add Previous Policy</button>
                            </div>
                        </div>
                        <div class="flex justify-between mt-6"><button type="button" onclick="navigateFormTab(-1)" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">&larr; Previous</button><button type="submit" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">Submit Data</button></div>
                    
                        </div>
                </form>
             </div>
        </div>

        <!-- Data View -->
        <div id="data-view" class="hidden">
            <div class="max-w-4xl mx-auto">
                <!-- Header container with relative positioning -->
                <div class="relative flex justify-center items-center mb-8">
                    <div class="absolute left-0"><img src="data:image/png;base64, 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" alt="Company Logo" class="h-16"></div>
                    <h1 class="text-3xl font-bold text-gray-800">Data Sheet</h1>
                    <div class="absolute right-0 text-right">
                        <h2 class="text-xl font-bold text-gray-800">Rapolu Venkateshwarlu</h2>
                        <p class="text-sm text-gray-600">Insurance Advisor</p>
                    </div>
                </div>

                    <!-- Main Tab Navigation -->
                <div class="flex justify-center space-x-4 mb-8">
                    <button id="form-tab-button" class="main-tab-button" onclick="showMainTab('form-view')">Data Entry Form</button>
                    <button id="view-tab-button" class="main-tab-button active" onclick="showMainTab('data-view')">View Submitted Data</button>
                </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                 <div class="flex justify-center sm:justify-end mb-6 space-x-4">
                    <div class="flex flex-wrap gap-4 mb-6">
                        <button id="export-json" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                            📁 Export
                        </button>
                        <label for="import-json" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition duration-300 cursor-pointer">
                            📂 Import
                        </label>
                        <input type="file" id="import-json" accept=".json" style="display: none;">
                        <button id="clear-data" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition duration-300">Clear Data</button>
                    </div>
                </div>

                <div class="mb-4 p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded">
                    <strong>Security Note:</strong> Data is stored locally in your browser. For production use, implement server-side storage and encryption.
                </div>

                <div class="mb-4">
                    <input type="text" id="search-input" placeholder="Search by name or policy number..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div id="data-table-container" class="overflow-x-auto">
                    <!-- Table will be generated here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gemini AI Modal -->
    <div id="gemini-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold">AI Generated Content</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modal-body">
                <div class="flex items-center justify-center h-32">
                    <div class="loader"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="copy-button" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Copy Text</button>
                <button onclick="closeModal()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Row Details Modal -->
    <div id="row-details-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="row-modal-title" class="text-xl font-bold">Policy Details</h3>
                <button onclick="closeRowDetails()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <!-- Modal tabs -->
            <div class="mb-4 border-b border-gray-200">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="modal-tab-overview" class="py-2 px-4 text-sm font-medium text-gray-700 border-b-2 border-transparent" type="button">Overview</button>
                    <button id="modal-tab-prevpol" class="py-2 px-4 text-sm font-medium text-gray-700 border-b-2 border-transparent" type="button">Previous Policies</button>
                    <button id="modal-tab-nominee" class="py-2 px-4 text-sm font-medium text-gray-700 border-b-2 border-transparent" type="button">Nominees</button>
                </nav>
            </div>

            <div id="row-modal-body" class="text-sm text-gray-700 max-h-[65vh] overflow-y-auto">
                <!-- Overview content -->
                <div id="row-modal-overview" class="grid gap-4 grid-cols-1 sm:grid-cols-2"></div>

                <!-- Previous policies content (hidden by default) -->
                <div id="row-modal-prevpol" class="hidden">
                    <div class="flex items-start space-x-4">
                        <div id="prevpol-list" class="w-1/3 border-r pr-4 space-y-2 max-h-[55vh] overflow-y-auto">
                            <!-- policy list injected here -->
                        </div>
                        <div id="prevpol-detail" class="w-2/3 pl-4">
                            <!-- selected policy details -->
                        </div>
                    </div>
                </div>

                <!-- Nominees content (hidden by default) - converted to a selectable list + detail pane -->
                <div id="row-modal-nominee" class="hidden">
                    <!-- Appointee container placed above the two-column nominee list/detail so it appears first -->
                    <div id="appointee-container" class="mb-3"></div>
                    <div class="flex items-start space-x-4">
                        <div id="nominee-list" class="w-1/3 border-r pr-4 space-y-2 max-h-[50vh] overflow-y-auto">
                            <!-- nominee list injected here -->
                        </div>
                        <div id="nominee-detail" class="w-2/3 pl-4">
                            <!-- selected nominee details injected here (nominee cards will be rendered below the Appointee container) -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="row-modal-edit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Edit</button>
                <button type="button" onclick="closeRowDetails()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>


    <script>
        const CSV_HEADERS = [
            'name_of_la', 'proposer', 'aadhaar', 'pan', 'ckyc', 'abha', 'f_name', 'm_name', 'gender', 'is_married', 'spouse', 'd_marriage', 'mobile_adhar', 'mobile', 
            'whatsapp', 'email', 'dob', 'birth_place', 'near_lb_age', 'residential_status',
            'corr_same_kyc', 'corr_address', 'address', 'bank_name', 'ac_type', 'ac_holder_name', 'bank_address', 'ac_no',
            'micr_code', 'ifsc_code', 'nominee_aadhaar', 'nominee', 'nominee_age', 'nominee_relation', 'appointee', 'appointee_relation', 'appointee_age',
            'plan_term', 'ppt', 'mode', 'sum_assured', 'ab_addb', 'term_rider', 'premium',
            'dating_back', 'dating_back_date', 'pwb', 'boc_number', 'boc_date', 'boc_amt', 'doc', 'policy_no', 'current_job',
            'type_of_duty', 'co_name', 'since', 'education', 'a_income', 'husband_occupation', 'husband_annual_income',
            'total_experience', 'ly_income1', 'ly_income2', 'ly_income3', 'prev_policy_no', 'prev_branch', 'prev_plan_term', 'prev_sa',
            'prev_y_premium', 'prev_ab_addb', 'prev_doc', 'prev_or', 'prev_m_nm', 'prev_inforce', 'fam_father_age', 'fam_father_state', 'fam_father_died_age',
            'fam_father_died_year', 'fam_father_died_cause', 'fam_mother_age', 'fam_mother_state',
            'fam_mother_died_age', 'fam_mother_died_year', 'fam_mother_died_cause', 'fam_spouse_age', 'fam_spouse_state', 'fam_spouse_died_age', 'fam_spouse_died_year', 'fam_spouse_died_cause',
            'fam_brother_age', 'fam_brother_state', 'fam_brother_died_age', 'fam_brother_died_year', 'fam_brother_died_cause',
            'fam_sister_age', 'fam_sister_state', 'fam_sister_died_age', 'fam_sister_died_year', 'fam_sister_died_cause',
            'fam_child_age', 'fam_child_state', 'fam_child_died_age', 'fam_child_died_year', 'fam_child_died_cause',
            'fam_brothers', 'fam_sisters', 'fam_children', 'height', 'weight', 'abd', 'any_operations', 'operation_details', 
            'any_diseases', 'disease_details', 'are_pregnant', 'last_delivery_date', 'nominees', 'previous_policies'
        ];

        // --- Gemini API Integration ---
        const API_KEY = "AIzaSyBaH3Um6fbT8zxMoiTF4lyNFhn-HWzC_RQ"; // Kept empty as per instructions for Canvas environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        async function callGeminiAPI(prompt, maxRetries = 3) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                         throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) await new Promise(res => setTimeout(res, 1000 * Math.pow(2, i)));
                    else return "Sorry, there was an error contacting the AI. Please try again later.";
                }
            }
        }

        // --- Main Application Logic ---
    let currentFormTabIndex = 0;
    // When editing an existing stored row, this holds its index; null means creating new
    let editingIndex = null;
        const formTabPanels = document.querySelectorAll('.form-tab-panel');
        const formTabsNav = document.getElementById('form-tabs-nav');

        // --- Age calculation helpers ---
        function calculateAgeFromDOB(dobString) {
            if (!dobString) return null;
            const dob = new Date(dobString);
            if (isNaN(dob)) return null;
            const now = new Date();
            // Normalize times to midnight to avoid timezone day shifts
            const y1 = dob.getFullYear(), m1 = dob.getMonth(), d1 = dob.getDate();
            const y2 = now.getFullYear(), m2 = now.getMonth(), d2 = now.getDate();

            let years = y2 - y1;
            let months = m2 - m1;
            let days = d2 - d1;

            if (days < 0) {
                // borrow days from previous month
                const prevMonth = new Date(y2, m2, 0); // last day of previous month
                days += prevMonth.getDate();
                months -= 1;
            }
            if (months < 0) {
                months += 12;
                years -= 1;
            }
            if (years < 0) return null; // DOB is in future
            return { years, months, days };
        }

        function formatAgeObject(ageObj) {
            if (!ageObj) return '';
            const parts = [];
            if (typeof ageObj.years === 'number') parts.push(`${ageObj.years} Year${ageObj.years !== 1 ? 's' : ''}`);
            if (typeof ageObj.months === 'number') parts.push(`${ageObj.months} Month${ageObj.months !== 1 ? 's' : ''}`);
            if (typeof ageObj.days === 'number') parts.push(`${ageObj.days} Day${ageObj.days !== 1 ? 's' : ''}`);
            return parts.join(', ');
        }

        function updateAgeFieldFromDOB(dobValue) {
            const ageStr = formatAgeObject(calculateAgeFromDOB(dobValue));
            const ageEl = document.getElementById('near_lb_age');
            if (ageEl) ageEl.value = ageStr || '';
        }

        // Show or hide marriage-dependent fields (spouse, d_marriage) and toggle required attribute
        function updateMarriageDependentVisibility(value) {
            const dependents = document.querySelectorAll('.marriage-dependent');
            const show = value === 'Yes';
            dependents.forEach(el => {
                if (show) el.classList.remove('hidden'); else el.classList.add('hidden');
                // toggle required attribute on inputs/selects inside
                const inputs = el.querySelectorAll('input, select, textarea');
                inputs.forEach(i => {
                    if (show) i.setAttribute('required', 'required'); else i.removeAttribute('required');
                });
            });
            // If not married, clear dependent input values to avoid stale data
            if (!show) {
                try {
                    const spouse = document.getElementById('spouse');
                    const dmar = document.getElementById('d_marriage');
                    if (spouse) spouse.value = '';
                    if (dmar) dmar.value = '';
                } catch (e) { /* ignore */ }
            }
        }

        // Show or hide the Dating Back Date field based on the dating_back select
        function updateDatingBackVisibility(value) {
            const container = document.getElementById('dating-back-date-container');
            const input = document.getElementById('dating_back_date');
            const show = value === 'Yes';
            if (container) {
                if (show) container.classList.remove('hidden'); else container.classList.add('hidden');
            }
            if (input) {
                if (show) input.setAttribute('required', 'required'); else input.removeAttribute('required');
                // if hiding, clear value to avoid stale data
                if (!show) input.value = '';
            }
        }

        // Show or hide family member death detail containers based on state selects
        function updateParentDeathVisibility(member, value) {
            // map member key to container id
            const map = {
                father: 'father-death-container',
                mother: 'mother-death-container',
                spouse: 'spouse-death-container',
                brother: 'brother-death-container',
                sister: 'sister-death-container',
                child: 'child-death-container'
            };
            const containerId = map[member];
            if (!containerId) return;
            const container = document.getElementById(containerId);
            const show = value === 'Dead';
            if (!container) return;
            if (show) container.classList.remove('hidden'); else container.classList.add('hidden');
            // toggle required on inputs inside and clear values when hiding
            const inputs = container.querySelectorAll('input, select, textarea');
            inputs.forEach(i => {
                if (show) i.setAttribute('required', 'required'); else i.removeAttribute('required');
                if (!show) i.value = '';
            });
        }

        // Show or hide operation details when Any Operations is Yes/No
        function updateOperationsVisibility(value) {
            const container = document.getElementById('operation-details-container');
            const input = document.getElementById('operation_details');
            const show = value === 'Yes';
            if (container) container.classList.toggle('hidden', !show);
            if (input) {
                if (show) input.setAttribute('required', 'required'); else input.removeAttribute('required');
                if (!show) input.value = '';
            }
        }

        // Show or hide disease details when Any Diseases is Yes/No
        function updateDiseasesVisibility(value) {
            const container = document.getElementById('disease-details-container');
            const input = document.getElementById('disease_details');
            const show = value === 'Yes';
            if (container) container.classList.toggle('hidden', !show);
            if (input) {
                if (show) input.setAttribute('required', 'required'); else input.removeAttribute('required');
                if (!show) input.value = '';
            }
        }

        // Show or hide pregnancy-related fields when Gender is Female
        function updatePregnancyVisibility(gender) {
            const pregSection = document.getElementById('pregnancy-section');
            const pregSelect = document.getElementById('are_pregnant');
            const husbandSection = document.getElementById('husband-details-section');
            const husbandOcc = document.getElementById('husband_occupation');
            const husbandInc = document.getElementById('husband_annual_income');
            const show = String(gender || '').toLowerCase() === 'female';
            if (pregSection) pregSection.classList.toggle('hidden', !show);
            if (husbandSection) husbandSection.classList.toggle('hidden', !show);
            if (pregSelect) {
                if (show) pregSelect.setAttribute('required', 'required'); else pregSelect.removeAttribute('required');
                if (!show) pregSelect.value = '';
            }
            // toggle husband fields required/clear when hiding
            if (husbandOcc) {
                if (show) husbandOcc.removeAttribute('disabled'); else { husbandOcc.value = ''; husbandOcc.removeAttribute('required'); }
            }
            if (husbandInc) {
                if (show) husbandInc.removeAttribute('disabled'); else { husbandInc.value = ''; husbandInc.removeAttribute('required'); }
            }
            // clear last delivery date when hiding
            if (!show) {
                const el = document.getElementById('last_delivery_date');
                if (el) el.value = '';
                if (el) el.removeAttribute('required');
            }
            // Adjust delivery field visibility based on children count (if gender is female, delivery visibility may still depend on num_children)
            try { updateDeliveryVisibility(); } catch (e) { /* ignore */ }
        }

        // Show or hide the Date of Last Delivery based on gender and number of children
        function updateDeliveryVisibility() {
            const lastDelContainer = document.getElementById('last-delivery-container');
            const ldInput = document.getElementById('last_delivery_date');
            const gender = (document.getElementById('gender') && document.getElementById('gender').value) || '';
            const numChildrenEl = document.getElementById('num_children');
            const numChildren = numChildrenEl ? parseInt(numChildrenEl.value || '0', 10) : 0;
            const show = String(gender).toLowerCase() === 'female' && Number.isFinite(numChildren) && numChildren > 0;
            if (lastDelContainer) lastDelContainer.classList.toggle('hidden', !show);
            if (ldInput) {
                if (show) {
                    ldInput.setAttribute('required', 'required');
                } else {
                    ldInput.removeAttribute('required');
                    ldInput.value = '';
                }
            }
        }

        // --- Currency formatting helpers (Indian grouping) ---
        function stripFormatting(val) {
            if (val === null || val === undefined) return '';
            return String(val).replace(/[\u20B9,\s]/g, '').trim(); // remove ₹ and commas and spaces
        }

        function formatIndianNumber(x) {
            if (x === null || x === undefined) return '';
            const s = String(x).replace(/[^0-9.-]/g, '');
            if (s === '' || isNaN(Number(s))) return '';
            // handle negative or decimal parts
            const neg = s.startsWith('-');
            const parts = s.replace('-', '').split('.');
            let intPart = parts[0];
            const decPart = parts[1] ? '.' + parts[1] : '';
            // first group 3 digits, then groups of 2
            if (intPart.length > 3) {
                const last3 = intPart.slice(-3);
                let rest = intPart.slice(0, -3);
                rest = rest.replace(/\B(?=(\d{2})+(?!\d))/g, ',');
                intPart = rest + ',' + last3;
            }
            const res = (neg ? '-' : '') + intPart + decPart;
            return res;
        }

        function showMainTab(tabId) {
            document.getElementById('form-view').classList.toggle('hidden', tabId !== 'form-view');
            document.getElementById('data-view').classList.toggle('hidden', tabId !== 'data-view');
            document.getElementById('form-tab-button').classList.toggle('active', tabId === 'form-view');
            document.getElementById('view-tab-button').classList.toggle('active', tabId === 'data-view');
            if (tabId === 'data-view') renderDataTable();
            // ensure the newly shown main container scrolls to top
            try { scrollElementToTop(tabId === 'form-view' ? document.getElementById('form-view') : document.getElementById('data-view')); } catch (e) { /* ignore */ }
        }

        function getStoredData() {
            const data = localStorage.getItem('formData');
            return data ? JSON.parse(data) : [];
        }

        // --- Form Tab & Validation Logic ---
        function initializeFormTabs() {
            formTabsNav.innerHTML = '';
            formTabPanels.forEach((panel, index) => {
                const tabName = panel.getAttribute('data-tab-name');
                const button = document.createElement('button');
                button.type = 'button';
                button.innerText = tabName;
                button.className = 'form-tab-button font-semibold text-gray-600 focus:outline-none';
                if (index === 0) button.classList.add('active');
                button.onclick = () => {
                    if (index > currentFormTabIndex) {
                        // Going forward: validate current tab
                        if (!validateTab(currentFormTabIndex)) {
                            alert('Please fill all mandatory fields in the current tab before proceeding.');
                            return;
                        }
                    }
                    // Allow going back freely or forward if valid
                    showFormTab(index);
                };
                formTabsNav.appendChild(button);
            });
        }

        function updateProgress() {
            const totalTabs = formTabPanels.length;
            const current = currentFormTabIndex + 1;
            const percentage = (current / totalTabs) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = current + ' of ' + totalTabs;
        }

        function showFormTab(tabIndex) {
            formTabPanels.forEach(panel => panel.classList.add('hidden'));
            formTabPanels[tabIndex].classList.remove('hidden');
            const navButtons = formTabsNav.querySelectorAll('button');
            navButtons.forEach((button, index) => button.classList.toggle('active', index === tabIndex));
            currentFormTabIndex = tabIndex;
            updateProgress();
            // scroll the visible form tab panel to top so user always starts at top
            try { scrollElementToTop(formTabPanels[tabIndex]); } catch (e) { /* ignore */ }
        }

        function navigateFormTab(direction) {
            const newIndex = currentFormTabIndex + direction;
            if (newIndex < 0 || newIndex >= formTabPanels.length) return; // out of bounds

            if (direction > 0) {
                // Going forward: validate current tab
                if (!validateTab(currentFormTabIndex)) {
                    alert('Please fill all mandatory fields in the current tab before proceeding.');
                    return;
                }
            }
            // Allow going back freely or forward if valid
            showFormTab(newIndex);
        }

        function validateTab(tabIndex) {
            let isValid = true;
            const panel = formTabPanels[tabIndex];
            panel.querySelectorAll('.error-message').forEach(err => err.textContent = '');

            const inputs = panel.querySelectorAll('input[required], select[required], input[type="email"], input[type="tel"], input[min]');
            inputs.forEach(input => {
                let errorMessage = '';
                if (input.required && !input.value.trim()) {
                    errorMessage = 'This field is required.';
                } else if (input.type === 'email' && input.value && !/^\S+@\S+\.\S+$/.test(input.value)) {
                    errorMessage = 'Please enter a valid email address.';
                } else if (input.type === 'tel' && input.value && input.pattern && !new RegExp(input.pattern).test(input.value)) {
                    errorMessage = input.title || 'Please enter a valid number.';
                } else if (input.type === 'number' && input.min !== '' && input.value !== '' && parseFloat(input.value) < parseFloat(input.min)) {
                    errorMessage = `Value cannot be less than ${input.min}.`;
                }
                
                if (errorMessage) {
                    isValid = false;
                    const errorSpan = input.parentElement.querySelector('.error-message');
                    if(errorSpan) errorSpan.textContent = errorMessage;
                }
            });
            return isValid;
        }

        // --- Data Table & Actions ---
        function renderDataTable() {
            const allData = getStoredData();
            const tableContainer = document.getElementById('data-table-container');

            if (!tableContainer) return; // defensive

            if (allData.length === 0) {
                tableContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">No data has been submitted yet.</p>`;
                return;
            }

            let tableHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>`;
            // Empty header for the Edit icon column
            tableHTML += `<th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>`;
            // Header for row index (visible so each row has a stable identifier)
            tableHTML += `<th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>`;
            const headersToShow = ['name_of_la', 'policy_no', 'plan_term', 'premium', 'doc'];
            headersToShow.forEach(header => {
                const headerText = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${headerText}</th>`;
            });
            tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>`;
            tableHTML += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            allData.forEach((row, index) => {
                // make each row clickable by adding a data-index attribute and a clickable class
                tableHTML += `<tr data-index="${index}" class="cursor-pointer hover:bg-gray-50" onclick="openRowDetails(${index})">`;
                // Edit button as first column (icon-only button)
                tableHTML += `<td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700"><button onclick="event.stopPropagation(); editRow(${index})" title="Edit" class="p-2 rounded hover:bg-gray-100" aria-label="Edit">✏️</button></td>`;
                // Row number column (1-based)
                tableHTML += `<td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700">${index + 1}</td>`;
                headersToShow.forEach(header => {
                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[header] || 'N/A'}</td>`;
                });
                tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 space-x-2">
                    <button onclick="event.stopPropagation(); generateSummary(${index})" class="text-blue-600 hover:text-blue-800 font-semibold">✨</button>
                    <button onclick="event.stopPropagation(); deleteRow(${index})" title="Delete" aria-label="Delete" class="text-red-600 hover:text-red-800 font-semibold p-2">🗑️</button>
                </td>`;
                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
            // ensure table container scrolls to top when shown
            try { scrollElementToTop(tableContainer); } catch (e) { /* ignore */ }
        }

        function filterDataTable() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const rows = document.querySelectorAll('#data-table-container table tbody tr');
            rows.forEach(row => {
                const name = row.cells[2].textContent.toLowerCase(); // name column
                const policy = row.cells[3].textContent.toLowerCase(); // policy column
                if (name.includes(searchTerm) || policy.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Open the row details modal and populate all fields for review
        function openRowDetails(index) {
            const allData = getStoredData();
            const row = allData[index];
            if (!row) return alert('Row not found');

            // Prepare section map to render Overview (same grouping as before)
            const sectionMap = {};
            const sectionOrder = [];
            formTabPanels.forEach(panel => {
                const sectionName = panel.getAttribute('data-tab-name') || 'General';
                if (!sectionOrder.includes(sectionName)) sectionOrder.push(sectionName);
                panel.querySelectorAll('[name]').forEach(el => {
                    const name = el.getAttribute('name');
                    if (name) sectionMap[name] = sectionName;
                });
            });

            const grouped = {};
            CSV_HEADERS.forEach(key => {
                const section = sectionMap[key] || 'Other';
                if (!grouped[section]) grouped[section] = [];
                grouped[section].push(key);
            });

            // Compute which fields should be visible for this row
            // so the modal mirrors the same visibility rules as the form
            function computeVisibleForRow(r) {
                const visible = new Set(CSV_HEADERS);
                try {
                    // Marriage dependents
                    if ((r.is_married || '') !== 'Yes') {
                        visible.delete('spouse');
                        visible.delete('d_marriage');
                    }

                    // Dating back
                    if ((r.dating_back || '') !== 'Yes') {
                        visible.delete('dating_back_date');
                    }

                    // Operations / Diseases
                    if ((r.any_operations || '') !== 'Yes') visible.delete('operation_details');
                    if ((r.any_diseases || '') !== 'Yes') visible.delete('disease_details');

                    // Correspondence address: hide when same as KYC
                    const corr = (r.corr_same_kyc || '').toString();
                    if (corr === 'on' || corr === 'true' || corr === '1') visible.delete('corr_address');

                    // Pregnancy / Husband fields - only when gender is Female
                    const gender = (r.gender || '').toString().toLowerCase();
                    if (gender !== 'female') {
                        visible.delete('are_pregnant');
                        visible.delete('husband_occupation');
                        visible.delete('husband_annual_income');
                        visible.delete('last_delivery_date');
                    } else {
                        // Determine number of children robustly. Support:
                        // - explicit num_children field
                        // - fam_children as an array
                        // - fam_children as a JSON-encoded string
                        // - fam_children_count or legacy numeric string
                        let numChildren = 0;
                        try {
                            if (Array.isArray(r.fam_children)) {
                                numChildren = r.fam_children.length;
                            } else if (typeof r.fam_children === 'string' && r.fam_children.trim()) {
                                try {
                                    const parsed = JSON.parse(r.fam_children);
                                    if (Array.isArray(parsed)) numChildren = parsed.length;
                                    else numChildren = parseInt(r.fam_children, 10) || 0;
                                } catch (e) {
                                    numChildren = parseInt(r.fam_children, 10) || 0;
                                }
                            } else {
                                numChildren = parseInt(r.num_children || r.fam_children_count || r.fam_children || 0, 10) || 0;
                            }
                        } catch (e) {
                            numChildren = parseInt(r.num_children || r.fam_children_count || 0, 10) || 0;
                        }

                        if (!(Number.isFinite(numChildren) && numChildren > 0)) visible.delete('last_delivery_date');
                    }

                    // Parent / spouse death details: only visible when state === 'Dead'
                    ['father','mother','spouse'].forEach(role => {
                        const key = `fam_${role}_state`;
                        const state = (r[key] || '').toString();
                        if (state !== 'Dead') {
                            visible.delete(`fam_${role}_died_age`);
                            visible.delete(`fam_${role}_died_year`);
                            visible.delete(`fam_${role}_died_cause`);
                        }
                    });

                    // Sibling/child repeaters: hide sibling/child death detail fields if no data
                    try {
                        const bros = Array.isArray(r.fam_brothers) ? r.fam_brothers : (r.fam_brothers ? JSON.parse(r.fam_brothers) : []);
                        if (!Array.isArray(bros) || bros.length === 0) {
                            visible.delete('fam_brother_age');
                            visible.delete('fam_brother_state');
                            visible.delete('fam_brother_died_age');
                            visible.delete('fam_brother_died_year');
                            visible.delete('fam_brother_died_cause');
                        }
                    } catch (e) { /* ignore parse issues */ }
                    try {
                        const sis = Array.isArray(r.fam_sisters) ? r.fam_sisters : (r.fam_sisters ? JSON.parse(r.fam_sisters) : []);
                        if (!Array.isArray(sis) || sis.length === 0) {
                            visible.delete('fam_sister_age');
                            visible.delete('fam_sister_state');
                            visible.delete('fam_sister_died_age');
                            visible.delete('fam_sister_died_year');
                            visible.delete('fam_sister_died_cause');
                        }
                    } catch (e) { /* ignore parse issues */ }
                    try {
                        const ch = Array.isArray(r.fam_children) ? r.fam_children : (r.fam_children ? JSON.parse(r.fam_children) : []);
                        if (!Array.isArray(ch) || ch.length === 0) {
                            visible.delete('fam_child_age');
                            visible.delete('fam_child_state');
                            visible.delete('fam_child_died_age');
                            visible.delete('fam_child_died_year');
                            visible.delete('fam_child_died_cause');
                        }
                    } catch (e) { /* ignore parse issues */ }

                } catch (e) {
                    console.error('computeVisibleForRow failed', e);
                }
                return visible;
            }

            const visibleFields = computeVisibleForRow(row);

            // Populate Overview
            const overviewEl = document.getElementById('row-modal-overview');
            overviewEl.innerHTML = '';
            sectionOrder.forEach(sectionName => {
                // Skip the entire Previous Policy section — previous policies are shown in their own tab
                if (String(sectionName || '').toLowerCase().includes('previous')) return;
                const keys = grouped[sectionName] || [];
                // Exclude the repeater key and any legacy previous policy fields (those starting with prev_)
                // Also exclude appointee and nominee fields which belong in the Nominees tab
                const keysFiltered = keys.filter(k => k !== 'previous_policies' && k !== 'nominees' && !k.startsWith('prev_') && !['appointee','appointee_relation','appointee_age','nominee','nominee_aadhaar','nominee_age','nominee_relation'].includes(k));
                if (keysFiltered.length === 0) return;
                // For the Medical History section (label may vary), render subsections for Father, Mother, and Other Family
                const lowerName = String(sectionName || '').toLowerCase();
                if (lowerName.includes('medical') || lowerName.includes('family')) {
                    const header = document.createElement('div');
                    header.className = 'col-span-1 sm:col-span-2 pt-2 pb-1 border-b border-gray-200';
                    header.innerHTML = `<div class="text-sm font-semibold text-gray-800">${sectionName}</div>`;
                    overviewEl.appendChild(header);

                    // Helper to render a named subsection with a subset of keys
                    function renderSubsection(title, keysSubset) {
                        const subHeader = document.createElement('div');
                        subHeader.className = 'col-span-1 sm:col-span-2 pt-1';
                        subHeader.innerHTML = `<div class="text-xs font-medium text-gray-600">${title}</div>`;
                        overviewEl.appendChild(subHeader);
                        keysSubset.forEach(key => {
                            if (!visibleFields.has(key)) return;
                            let labelText = null;
                            try {
                                const lab = document.querySelector(`label[for="${key}"]`);
                                if (lab && lab.innerText && lab.innerText.trim()) {
                                    labelText = lab.innerText.replace(/\*+/g, '').trim();
                                }
                            } catch (e) { /* ignore */ }
                            if (!labelText) labelText = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            const value = row[key] || '';
                            const item = document.createElement('div');
                            item.className = 'detail-item p-2 rounded border border-transparent hover:border-gray-100';
                            item.innerHTML = `
                                <div class="text-xs text-gray-500">${labelText}</div>
                                <div class="text-sm text-gray-700">${value || '<span class="text-gray-400">(empty)</span>'}</div>
                            `;
                            overviewEl.appendChild(item);
                        });
                    }

                    // Father keys
                    const fatherKeys = keysFiltered.filter(k => k.startsWith('fam_father') || k === 'f_name');
                    // Mother keys
                    const motherKeys = keysFiltered.filter(k => k.startsWith('fam_mother') || k === 'm_name');
                    // Spouse keys
                    const spouseKeys = keysFiltered.filter(k => k.startsWith('fam_spouse') || k === 'spouse');
                    // Other family/medical keys (siblings, children, and remaining medical specifics)
                    const otherKeys = keysFiltered.filter(k => !fatherKeys.includes(k) && !motherKeys.includes(k) && !spouseKeys.includes(k));

                    if (fatherKeys.length > 0) renderSubsection('Father', fatherKeys);
                    if (motherKeys.length > 0) renderSubsection('Mother', motherKeys);
                    if (spouseKeys.length > 0) renderSubsection('Spouse', spouseKeys);

                    // Render repeaters (Brothers, Sisters, Children) as their own subsections when present
                    function renderRepeaterArray(titlePlural, arr, roleLabel) {
                        if (!Array.isArray(arr) || arr.length === 0) return;
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'col-span-1 sm:col-span-2 pt-1';
                        groupHeader.innerHTML = `<div class="text-sm font-semibold text-gray-800">${titlePlural} </div>`;
                        overviewEl.appendChild(groupHeader);

                        arr.forEach((it, idx) => {
                            const itemHeader = document.createElement('div');
                            itemHeader.className = 'col-span-1 sm:col-span-2 pt-1';
                            itemHeader.innerHTML = `<div class="text-xs font-medium text-gray-600">${roleLabel} ${idx + 1}</div>`;
                            overviewEl.appendChild(itemHeader);

                            const state = it.state || it.fam_brother_state || it.fam_sister_state || it.fam_child_state;
                            
                            const fields = [
                                { label: 'Age', value: it.age || it.fam_brother_age || it.fam_sister_age || it.fam_child_age },
                                { label: 'State', value: state }
                            ];

                            // Only show death-related fields if state is 'Dead'
                            if (state === 'Dead') {
                                fields.push(
                                    { label: 'Age at Death', value: it.died_age || it.fam_brother_died_age || it.fam_sister_died_age || it.fam_child_died_age },
                                    { label: 'Death Year', value: it.died_year || it.fam_brother_died_year || it.fam_sister_died_year || it.fam_child_died_year },
                                    { label: 'Cause of Death', value: it.died_cause || it.fam_brother_died_cause || it.fam_sister_died_cause || it.fam_child_died_cause }
                                );
                            }

                            fields.forEach(f => {
                                const item = document.createElement('div');
                                item.className = 'detail-item p-2 rounded border border-transparent hover:border-gray-100';
                                item.innerHTML = `
                                    <div class="text-xs text-gray-500">${f.label}</div>
                                    <div class="text-sm text-gray-700">${f.value || '<span class="text-gray-400">(empty)</span>'}</div>
                                `;
                                overviewEl.appendChild(item);
                            });
                        });
                    }

                    // Parse potential repeater JSON stored in the row (support both array and legacy JSON string)
                    let bros = [];
                    try { bros = Array.isArray(row.fam_brothers) ? row.fam_brothers : (row.fam_brothers ? JSON.parse(row.fam_brothers) : []); } catch (e) { bros = []; }
                    let sis = [];
                    try { sis = Array.isArray(row.fam_sisters) ? row.fam_sisters : (row.fam_sisters ? JSON.parse(row.fam_sisters) : []); } catch (e) { sis = []; }
                    let ch = [];
                    try { ch = Array.isArray(row.fam_children) ? row.fam_children : (row.fam_children ? JSON.parse(row.fam_children) : []); } catch (e) { ch = []; }

                    renderRepeaterArray('Brothers', bros, 'Brother');
                    renderRepeaterArray('Sisters', sis, 'Sister');
                    renderRepeaterArray('Children', ch, 'Child');

                    // Filter out repeater-related legacy keys from the remaining otherKeys
                    const leftoverKeys = otherKeys.filter(k => !k.startsWith('fam_brother') && !k.startsWith('fam_sister') && !k.startsWith('fam_child'));
                    if (leftoverKeys.length > 0) renderSubsection('Medical', leftoverKeys);
                } else {
                    const header = document.createElement('div');
                    header.className = 'col-span-1 sm:col-span-2 pt-2 pb-1 border-b border-gray-200';
                    header.innerHTML = `<div class="text-sm font-semibold text-gray-800">${sectionName}</div>`;
                    overviewEl.appendChild(header);

                    keysFiltered.forEach(key => {
                        // skip fields that would be hidden in the data-entry form for this saved row
                        if (!visibleFields.has(key)) return;
                        // Prefer the real form label text if available
                        let labelText = null;
                        try {
                            const lab = document.querySelector(`label[for="${key}"]`);
                            if (lab && lab.innerText && lab.innerText.trim()) {
                                // Remove any trailing required asterisk from label text for clean display
                                labelText = lab.innerText.replace(/\*+/g, '').trim();
                            }
                        } catch (e) { /* ignore */ }
                        if (!labelText) labelText = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const value = row[key] || '';
                        const item = document.createElement('div');
                        item.className = 'detail-item p-2 rounded border border-transparent hover:border-gray-100';
                        item.innerHTML = `
                            <div class="text-xs text-gray-500">${labelText}</div>
                            <div class="text-sm text-gray-700">${value || '<span class="text-gray-400">(empty)</span>'}</div>
                        `;
                        overviewEl.appendChild(item);
                    });
                }
            });

            // Populate Previous Policies tab
            const prevListEl = document.getElementById('prevpol-list');
            const prevDetailEl = document.getElementById('prevpol-detail');
            prevListEl.innerHTML = '';
            prevDetailEl.innerHTML = '';
            // Support both the newer repeater array and legacy single previous policy fields
            let policies = Array.isArray(row.previous_policies) ? row.previous_policies : [];
            if ((!policies || policies.length === 0) && (row.prev_policy_no || row.prev_plan_term || row.prev_y_premium)) {
                policies = [{
                    prev_policy_no: row.prev_policy_no || '',
                    prev_branch: row.prev_branch || '',
                    prev_plan_term: row.prev_plan_term || '',
                    prev_sa: row.prev_sa || '',
                    prev_y_premium: row.prev_y_premium || '',
                    prev_ab_addb: row.prev_ab_addb || '',
                    prev_doc: row.prev_doc || '',
                    prev_or: row.prev_or || '',
                    prev_m_nm: row.prev_m_nm || '',
                    prev_inforce: row.prev_inforce || ''
                }];
            }

            if (policies.length === 0) {
                prevListEl.innerHTML = `<div class="text-sm text-gray-500">No previous policies saved.</div>`;
                prevDetailEl.innerHTML = `<div class="text-sm text-gray-500">Select a policy to view details.</div>`;
            } else {
                policies.forEach((pol, i) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'w-full text-left p-2 rounded hover:bg-gray-100';
                    btn.innerHTML = `<div class="text-sm font-medium">Policy ${i + 1}</div><div class="text-xs text-gray-500">${pol.prev_policy_no || ''}</div>`;
                    btn.addEventListener('click', () => {
                        // render this policy's details
                        prevDetailEl.innerHTML = '';
                        const card = document.createElement('div');
                        card.className = 'p-3 border rounded bg-white';
                        card.innerHTML = `
                            <div class="grid grid-cols-1 gap-1 text-xs text-gray-600">
                                <div><strong>Policy Number:</strong> <span class="text-gray-700">${pol.prev_policy_no || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>Branch:</strong> <span class="text-gray-700">${pol.prev_branch || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>Plan/Term:</strong> <span class="text-gray-700">${pol.prev_plan_term || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>Sum Assured:</strong> <span class="text-gray-700">${pol.prev_sa || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>Premium:</strong> <span class="text-gray-700">${pol.prev_y_premium || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>Accidental Benefit:</strong> <span class="text-gray-700">${pol.prev_ab_addb || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>Date of Commencement:</strong> <span class="text-gray-700">${pol.prev_doc || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>OR:</strong> <span class="text-gray-700">${pol.prev_or || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>Medical:</strong> <span class="text-gray-700">${pol.prev_m_nm || '<span class="text-gray-400">(empty)</span>'}</span></div>
                                <div><strong>Inforce:</strong> <span class="text-gray-700">${pol.prev_inforce || '<span class="text-gray-400">(empty)</span>'}</span></div>
                            </div>
                        `;
                        prevDetailEl.appendChild(card);
                    });
                    prevListEl.appendChild(btn);
                });
                // auto-click first
                setTimeout(() => { const firstBtn = prevListEl.querySelector('button'); if (firstBtn) firstBtn.click(); }, 20);
            }

            // Wire Edit button inside modal
            const editBtn = document.getElementById('row-modal-edit');
            editBtn.onclick = (e) => {
                e.stopPropagation();
                closeRowDetails();
                setTimeout(() => editRow(index), 80);
            };

            // Tab switching behavior
            const tabOverview = document.getElementById('modal-tab-overview');
            const tabPrev = document.getElementById('modal-tab-prevpol');
            const bodyOverview = document.getElementById('row-modal-overview');
            const bodyPrev = document.getElementById('row-modal-prevpol');

            function activateOverview() {
                // Clear active state from all tabs first to ensure only the overview is highlighted
                const tabNomLocal = document.getElementById('modal-tab-nominee');
                [tabOverview, tabPrev, tabNomLocal].forEach(t => {
                    if (!t) return;
                    t.classList.remove('text-blue-600');
                    t.classList.remove('border-b-2');
                    t.classList.add('border-transparent');
                });
                // Activate Overview tab
                tabOverview.classList.add('text-blue-600');
                tabOverview.classList.remove('border-transparent');
                tabOverview.classList.add('border-b-2');
                bodyOverview.classList.remove('hidden');
                bodyPrev.classList.add('hidden');
                // hide nominee body if present
                const bodyNom = document.getElementById('row-modal-nominee');
                if (bodyNom) bodyNom.classList.add('hidden');
                // scroll overview body and modal to top
                try { const modalContent = document.getElementById('row-details-modal').querySelector('.modal-content'); scrollElementToTop(modalContent); scrollElementToTop(bodyOverview); } catch (e) { /* ignore */ }
            }
            function activatePrev() {
                // Clear active state from all tabs first so only Previous Policies is highlighted
                const tabNomLocal = document.getElementById('modal-tab-nominee');
                [tabOverview, tabPrev, tabNomLocal].forEach(t => {
                    if (!t) return;
                    t.classList.remove('text-blue-600');
                    t.classList.remove('border-b-2');
                    t.classList.add('border-transparent');
                });
                // Activate Previous Policies tab
                tabPrev.classList.add('text-blue-600');
                tabPrev.classList.add('border-b-2');
                bodyPrev.classList.remove('hidden');
                bodyOverview.classList.add('hidden');
                const bodyNom = document.getElementById('row-modal-nominee');
                if (bodyNom) bodyNom.classList.add('hidden');
                // scroll previous policies list/detail to top
                try { const modalContent = document.getElementById('row-details-modal').querySelector('.modal-content'); scrollElementToTop(modalContent); scrollElementToTop(bodyPrev); } catch (e) { /* ignore */ }
            }

            function activateNominee() {
                const tabNom = document.getElementById('modal-tab-nominee');
                const bodyNom = document.getElementById('row-modal-nominee');
                tabNom.classList.add('text-blue-600');
                tabNom.classList.add('border-b-2');
                tabOverview.classList.remove('text-blue-600');
                tabOverview.classList.remove('border-b-2');
                tabPrev.classList.remove('text-blue-600');
                tabPrev.classList.remove('border-b-2');
                if (bodyNom) bodyNom.classList.remove('hidden');
                bodyOverview.classList.add('hidden');
                bodyPrev.classList.add('hidden');
                // scroll nominee pane to top
                try { const modalContent = document.getElementById('row-details-modal').querySelector('.modal-content'); scrollElementToTop(modalContent); scrollElementToTop(document.getElementById('row-modal-nominee')); } catch (e) { /* ignore */ }
            }

            tabOverview.onclick = activateOverview;
            tabPrev.onclick = activatePrev;
            const tabNom = document.getElementById('modal-tab-nominee');
            if (tabNom) tabNom.onclick = activateNominee;

            // default to overview
            activateOverview();

            // Populate nominees into nominee tab as a selectable list + detail pane
            try {
                const listEl = document.getElementById('nominee-list');
                const detailEl = document.getElementById('nominee-detail');
                const appContainer = document.getElementById('appointee-container');
                if (listEl && detailEl && appContainer) {
                    listEl.innerHTML = '';
                    detailEl.innerHTML = '';
                    appContainer.innerHTML = '';

                    // Appointee card appears above the columns (non-selectable) and is always first
                    const hasAppointee = (row.appointee && String(row.appointee).trim()) || (row.appointee_relation && String(row.appointee_relation).trim()) || (row.appointee_age && String(row.appointee_age).trim());
                    if (hasAppointee) {
                        const appCard = document.createElement('div');
                        appCard.className = 'p-3 border rounded bg-white';
                        appCard.innerHTML = `
                            <div class="text-sm font-semibold text-gray-800 mb-1">Appointee</div>
                            <div class="text-xs text-gray-600">Name: ${row.appointee || '<span class="text-gray-400">(empty)</span>'}</div>
                            <div class="text-xs text-gray-600">Relation: ${row.appointee_relation || '<span class="text-gray-400">(empty)</span>'}</div>
                            <div class="text-xs text-gray-600">Age: ${row.appointee_age || '<span class="text-gray-400">(empty)</span>'}</div>
                        `;
                        appContainer.appendChild(appCard);
                    }

                    // Load saved nominees
                    const savedNoms = Array.isArray(row.nominees) ? row.nominees : (row.nominees ? JSON.parse(row.nominees || '[]') : []);
                    if (!Array.isArray(savedNoms) || savedNoms.length === 0) {
                        // show empty state in list if no nominees
                        listEl.innerHTML = '<div class="text-sm text-gray-500">No nominees saved for this entry.</div>';
                        // show placeholder in detail pane when there are no nominees
                        detailEl.innerHTML = '<div class="text-sm text-gray-500">Select a nominee to view details.</div>';
                    } else {
                        // helper to render nominee details into detailEl (always appended below any appointee container)
                        function renderNomineeDetail(nom, idx) {
                            // clear previous nominee detail
                            detailEl.innerHTML = '';
                            // if there is an appointee, keep its visual separation by leaving appContainer alone
                            const card = document.createElement('div');
                            card.className = 'p-3 border rounded bg-white';
                            const name = nom.name || nom.nominee || '';
                            const share = (typeof nom.share !== 'undefined') ? nom.share : (nom.nominee_share || '');
                            const rel = nom.relation || nom.nominee_relation || '';
                            const dob = nom.dob || nom.nominee_dob || '';
                            const aad = nom.aadhaar || nom.nominee_aadhaar || '';
                            card.innerHTML = `
                                <div class="text-sm font-semibold text-gray-800 mb-1">${name || '(unnamed)'}</div>
                                <div class="text-xs text-gray-600">Share: ${share || '(unspecified)'}%</div>
                                <div class="text-xs text-gray-600">Relation: ${rel || '(unspecified)'}</div>
                                <div class="text-xs text-gray-600">DOB: ${dob || '(unspecified)'}</div>
                                <div class="text-xs text-gray-600">Aadhaar: ${aad || '(unspecified)'}</div>
                            `;
                            // If an appointee exists, render nominee detail after the visible appointee container by appending to detailEl (detailEl sits beside appContainer)
                            detailEl.appendChild(card);
                        }

                        // populate list buttons
                        savedNoms.forEach((n, i) => {
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'w-full text-left p-2 rounded hover:bg-gray-100';
                            const displayName = (n.name || n.nominee || `(Nominee ${i + 1})`);
                            btn.innerHTML = `<div class="text-sm font-medium">${displayName}</div><div class="text-xs text-gray-500">${n.relation || n.nominee_relation || ''}</div>`;
                            btn.addEventListener('click', () => {
                                // mark selected visually
                                Array.from(listEl.querySelectorAll('button')).forEach(b => b.classList.remove('bg-blue-50'));
                                btn.classList.add('bg-blue-50');
                                renderNomineeDetail(n, i);
                            });
                            listEl.appendChild(btn);
                        });

                        // auto-select first nominee
                        setTimeout(() => {
                            const firstBtn = listEl.querySelector('button');
                            if (firstBtn) firstBtn.click();
                        }, 20);
                    }
                }
            } catch (e) { console.error('Nominee render failed', e); }

            document.getElementById('row-details-modal').classList.remove('hidden');
            // ensure modal content starts at top when opened
            try {
                const modal = document.getElementById('row-details-modal');
                const modalContent = modal.querySelector('.modal-content');
                scrollElementToTop(modalContent);
                const overview = document.getElementById('row-modal-overview');
                if (overview) scrollElementToTop(overview);
            } catch (e) { /* ignore */ }
        }

        // Utility: scroll an element (or document) to its top-left smoothly
        function scrollElementToTop(el) {
            try {
                if (!el) { window.scrollTo({ top: 0, left: 0, behavior: 'smooth' }); return; }
                // If element is the document body or html, scroll window
                if (el === document.body || el === document.documentElement) {
                    window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
                    return;
                }
                // For containers with overflow, set scrollTop
                if (typeof el.scrollTo === 'function') {
                    // prefer instant jump to avoid showing previous content while animating
                    el.scrollTop = 0;
                    el.scrollLeft = 0;
                } else if (el instanceof HTMLElement) {
                    el.scrollTop = 0;
                    el.scrollLeft = 0;
                } else {
                    window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
                }
            } catch (e) { /* ignore */ }
        }

        // --- Previous Policies Repeater Helpers ---
        function createPreviousPolicyNode(data = {}) {
            const tpl = document.getElementById('previous-policy-template');
            const node = tpl.content.firstElementChild.cloneNode(true);
            // populate fields
            const map = ['prev_policy_no','prev_branch','prev_plan_term','prev_sa','prev_y_premium','prev_ab_addb','prev_doc','prev_mode','prev_or','prev_m_nm','prev_inforce'];
            const classMap = {
                prev_policy_no: 'prev-policy-no',
                prev_branch: 'prev-branch',
                prev_plan_term: 'prev-plan-term',
                prev_sa: 'prev-sa',
                prev_y_premium: 'prev-y-premium',
                prev_ab_addb: 'prev-ab-addb',
                prev_doc: 'prev-doc',
                prev_mode: 'prev-mode',
                prev_or: 'prev-or',
                prev_m_nm: 'prev-m-nm',
                prev_inforce: 'prev-inforce'
            };
            map.forEach(k => {
                const cls = classMap[k] || k.replace(/_/g, '-');
                const el = node.querySelector('.' + cls);
                if (el && data[k] !== undefined && data[k] !== null) el.value = data[k];
            });
            // remove handler
            node.querySelector('.remove-previous-policy').addEventListener('click', () => {
                node.remove();
            });
            return node;
        }

        // --- Nominees Repeater Helpers ---
        function createNomineeNode(data = {}) {
            const tpl = document.getElementById('nominee-template');
            const node = tpl.content.firstElementChild.cloneNode(true);
            // populate fields
            const nameEl = node.querySelector('.nominee-name');
            const shareEl = node.querySelector('.nominee-share');
            const dobEl = node.querySelector('.nominee-dob');
            const relEl = node.querySelector('.nominee-relation');
            const aadEl = node.querySelector('.nominee-aadhaar');
            if (nameEl && data.name) nameEl.value = data.name;
            if (shareEl && typeof data.share !== 'undefined') shareEl.value = data.share;
            if (dobEl && data.dob) dobEl.value = data.dob;
            if (relEl && data.relation) relEl.value = data.relation;
            if (aadEl && data.aadhaar) aadEl.value = data.aadhaar;

            node.querySelector('.remove-nominee').addEventListener('click', () => {
                node.remove();
                // re-validate shares when removing
                validateNomineeShares();
            });
            // re-validate shares on input change
            [node.querySelector('.nominee-share'), node.querySelector('.nominee-name')].forEach(el => {
                if (!el) return;
                el.addEventListener('input', () => validateNomineeShares());
            });
            return node;
        }

        function getNomineesFromRepeater() {
            const container = document.getElementById('nominees-repeater');
            const items = Array.from(container.querySelectorAll('.nominee-item'));
            return items.map(item => {
                return {
                    name: (item.querySelector('.nominee-name') || { value: '' }).value.trim(),
                    share: (item.querySelector('.nominee-share') || { value: '' }).value.trim(),
                    dob: (item.querySelector('.nominee-dob') || { value: '' }).value,
                    relation: (item.querySelector('.nominee-relation') || { value: '' }).value.trim(),
                    aadhaar: (item.querySelector('.nominee-aadhaar') || { value: '' }).value.trim()
                };
            }).filter(n => n.name || n.share || n.dob || n.relation || n.aadhaar);
        }

        function clearNomineesRepeater() {
            const container = document.getElementById('nominees-repeater');
            if (container) container.innerHTML = '';
        }

        function loadNomineesIntoRepeater(list) {
            clearNomineesRepeater();
            const container = document.getElementById('nominees-repeater');
            if (!Array.isArray(list) || !container) return;
            list.forEach(item => container.appendChild(createNomineeNode({
                name: item.name || item.nominee || '',
                share: item.share || item.nominee_share || '',
                dob: item.dob || item.nominee_dob || '',
                relation: item.relation || item.nominee_relation || '',
                aadhaar: item.aadhaar || item.nominee_aadhaar || ''
            })));
            // validate after load
            validateNomineeShares();
        }

        function validateNomineeShares() {
            const errEl = document.getElementById('nominee-error');
            if (!errEl) return true;
            const nominees = getNomineesFromRepeater();
            if (nominees.length === 0) { errEl.textContent = ''; return true; }
            // sum shares (allow decimals)
            const sum = nominees.reduce((s, n) => s + (parseFloat(n.share) || 0), 0);
            // check close to 100 (allow small float epsilon)
            if (Math.abs(sum - 100) > 0.001) {
                errEl.textContent = `Total nominee shares must equal 100%. Current total: ${sum}%`;
                return false;
            }
            errEl.textContent = '';
            return true;
        }

        // Expose nominee helpers globally for edit flow
        window.loadNomineesIntoRepeater = loadNomineesIntoRepeater;
        window.getNomineesFromRepeater = getNomineesFromRepeater;

        function getPreviousPoliciesFromRepeater() {
            const container = document.getElementById('previous-policies-repeater');
            const items = Array.from(container.querySelectorAll('.previous-policy-item'));
            return items.map(item => {
                const obj = {};
                const keys = ['prev_policy_no','prev_branch','prev_plan_term','prev_sa','prev_y_premium','prev_ab_addb','prev_doc','prev_mode','prev_or','prev_m_nm','prev_inforce'];
                const classMap = {
                    prev_policy_no: 'prev-policy-no',
                    prev_branch: 'prev-branch',
                    prev_plan_term: 'prev-plan-term',
                    prev_sa: 'prev-sa',
                    prev_y_premium: 'prev-y-premium',
                    prev_ab_addb: 'prev-ab-addb',
                    prev_doc: 'prev-doc',
                    prev_mode: 'prev-mode',
                    prev_or: 'prev-or',
                    prev_m_nm: 'prev-m-nm',
                    prev_inforce: 'prev-inforce'
                };
                keys.forEach(k => {
                    const cls = classMap[k] || k.replace(/_/g, '-');
                    const el = item.querySelector('.' + cls);
                    obj[k] = el ? el.value : '';
                });
                return obj;
            }).filter(x => Object.values(x).some(v => v && v.toString().trim() !== ''));
        }

        function clearPreviousPoliciesRepeater() {
            const container = document.getElementById('previous-policies-repeater');
            container.innerHTML = '';
        }

        function loadPreviousPoliciesIntoRepeater(list) {
            clearPreviousPoliciesRepeater();
            const container = document.getElementById('previous-policies-repeater');
            if (!Array.isArray(list)) return;
            list.forEach(item => {
                container.appendChild(createPreviousPolicyNode(item));
            });
        }

        // --- Siblings & Children repeaters helpers ---
        function createSiblingNode(data = {}, role = 'Sibling', index = null) {
            const tpl = document.getElementById('sibling-template');
            const node = tpl.content.firstElementChild.cloneNode(true);
            const ageEl = node.querySelector('.sibling-age');
            const stateEl = node.querySelector('.sibling-state');
            const diedAgeEl = node.querySelector('.sibling-died-age');
            const diedYearEl = node.querySelector('.sibling-died-year');
            const diedCauseEl = node.querySelector('.sibling-died-cause');
            const deathContainer = node.querySelector('.sibling-death-container');
            // set the small header to show role + ordinal (e.g., "Brother 1")
            try {
                const header = node.querySelector('.sibling-header');
                if (header) header.textContent = `${role}${index ? ' ' + index : ''}`;
            } catch (e) { /* ignore */ }
            if (ageEl && typeof data.age !== 'undefined') ageEl.value = data.age;
            if (stateEl && data.state) stateEl.value = data.state;
            if (diedAgeEl && data.died_age) diedAgeEl.value = data.died_age;
            if (diedYearEl && data.died_year) diedYearEl.value = data.died_year;
            if (diedCauseEl && data.died_cause) diedCauseEl.value = data.died_cause;
            // initialize death container visibility based on state
            try {
                const show = stateEl && stateEl.value === 'Dead';
                if (deathContainer) {
                    deathContainer.classList.toggle('hidden', !show);
                    // toggle required attributes
                    [diedAgeEl, diedYearEl, diedCauseEl].forEach(el => { if (!el) return; if (show) el.setAttribute('required', 'required'); else el.removeAttribute('required'); });
                }
            } catch (e) { /* ignore */ }
            node.querySelector('.remove-sibling').addEventListener('click', () => {
                // decrement the number input for this role so counts stay in sync
                try {
                    const numEl = document.getElementById(role.toLowerCase() === 'brother' ? 'num_brothers' : 'num_sisters');
                    if (numEl) numEl.value = Math.max(0, (parseInt(numEl.value || '0', 10) - 1));
                } catch (e) { /* ignore */ }
                node.remove();
                // renumber remaining
                renumberRepeaters(role);
            });
            // toggle death detail visibility when state changes
            if (stateEl) stateEl.addEventListener('change', (e) => {
                const show = e.target.value === 'Dead';
                if (deathContainer) deathContainer.classList.toggle('hidden', !show);
                [diedAgeEl, diedYearEl, diedCauseEl].forEach(el => { if (!el) return; if (show) el.setAttribute('required', 'required'); else { el.removeAttribute('required'); el.value = ''; } });
            });
            return node;
        }

        function createChildNode(data = {}, role = 'Child', index = null) {
            const tpl = document.getElementById('child-template');
            const node = tpl.content.firstElementChild.cloneNode(true);
            const ageEl = node.querySelector('.child-age');
            const stateEl = node.querySelector('.child-state');
            const diedAgeEl = node.querySelector('.child-died-age');
            const diedYearEl = node.querySelector('.child-died-year');
            const diedCauseEl = node.querySelector('.child-died-cause');
            const deathContainer = node.querySelector('.child-death-container');
            // set the small header to show role + ordinal (e.g., "Child 1")
            try {
                const header = node.querySelector('.child-header');
                if (header) header.textContent = `${role}${index ? ' ' + index : ''}`;
            } catch (e) { /* ignore */ }
            if (ageEl && typeof data.age !== 'undefined') ageEl.value = data.age;
            if (stateEl && data.state) stateEl.value = data.state;
            if (diedAgeEl && data.died_age) diedAgeEl.value = data.died_age;
            if (diedYearEl && data.died_year) diedYearEl.value = data.died_year;
            if (diedCauseEl && data.died_cause) diedCauseEl.value = data.died_cause;
            // initialize death container visibility based on state
            try {
                const show = stateEl && stateEl.value === 'Dead';
                if (deathContainer) {
                    deathContainer.classList.toggle('hidden', !show);
                    [diedAgeEl, diedYearEl, diedCauseEl].forEach(el => { if (!el) return; if (show) el.setAttribute('required', 'required'); else el.removeAttribute('required'); });
                }
            } catch (e) { /* ignore */ }
            node.querySelector('.remove-child').addEventListener('click', () => {
                try {
                    const numEl = document.getElementById('num_children');
                    if (numEl) numEl.value = Math.max(0, (parseInt(numEl.value || '0', 10) - 1));
                } catch (e) { /* ignore */ }
                node.remove();
                renumberRepeaters('Child');
            });
            if (stateEl) stateEl.addEventListener('change', (e) => {
                const show = e.target.value === 'Dead';
                if (deathContainer) deathContainer.classList.toggle('hidden', !show);
                [diedAgeEl, diedYearEl, diedCauseEl].forEach(el => { if (!el) return; if (show) el.setAttribute('required', 'required'); else { el.removeAttribute('required'); el.value = ''; } });
            });
            return node;
        }

        // Renumber headers for repeaters: role should be 'Brother'|'Sister'|'Child'
        function renumberRepeaters(role) {
            try {
                let selector = '';
                let headerClass = '';
                if (role.toLowerCase() === 'brother') { selector = '#brothers-repeater .sibling-item'; headerClass = 'sibling-header'; }
                else if (role.toLowerCase() === 'sister') { selector = '#sisters-repeater .sibling-item'; headerClass = 'sibling-header'; }
                else if (role.toLowerCase() === 'child') { selector = '#children-repeater .child-item'; headerClass = 'child-header'; }
                if (!selector) return;
                const items = Array.from(document.querySelectorAll(selector));
                items.forEach((node, i) => {
                    const header = node.querySelector('.' + headerClass);
                    if (header) header.textContent = `${role} ${i + 1}`;
                });
            } catch (e) { /* ignore */ }
        }

        function syncRepeatersFromCounts() {
            const bCount = parseInt(document.getElementById('num_brothers').value || '0', 10);
            const sCount = parseInt(document.getElementById('num_sisters').value || '0', 10);
            const cCount = parseInt(document.getElementById('num_children').value || '0', 10);
            const bContainer = document.getElementById('brothers-repeater');
            const sContainer = document.getElementById('sisters-repeater');
            const cContainer = document.getElementById('children-repeater');
            // adjust brothers
            while (bContainer.children.length < bCount) {
                const idx = bContainer.children.length + 1;
                bContainer.appendChild(createSiblingNode({}, 'Brother', idx));
            }
            while (bContainer.children.length > bCount) bContainer.lastElementChild.remove();
            // renumber brothers
            renumberRepeaters('Brother');
            // sisters
            while (sContainer.children.length < sCount) {
                const idx = sContainer.children.length + 1;
                sContainer.appendChild(createSiblingNode({}, 'Sister', idx));
            }
            while (sContainer.children.length > sCount) sContainer.lastElementChild.remove();
            renumberRepeaters('Sister');
            // children
            while (cContainer.children.length < cCount) {
                const idx = cContainer.children.length + 1;
                cContainer.appendChild(createChildNode({}, 'Child', idx));
            }
            while (cContainer.children.length > cCount) cContainer.lastElementChild.remove();
            renumberRepeaters('Child');
            // ensure delivery visibility updates when children count changes
            try { updateDeliveryVisibility(); } catch (e) { /* ignore */ }
        }

        function getRepeatersData() {
            const brothers = Array.from(document.querySelectorAll('#brothers-repeater .sibling-item')).map(node => ({
                age: (node.querySelector('.sibling-age')||{value:''}).value,
                state: (node.querySelector('.sibling-state')||{value:''}).value,
                died_age: (node.querySelector('.sibling-died-age')||{value:''}).value,
                died_year: (node.querySelector('.sibling-died-year')||{value:''}).value,
                died_cause: (node.querySelector('.sibling-died-cause')||{value:''}).value
            }));
            const sisters = Array.from(document.querySelectorAll('#sisters-repeater .sibling-item')).map(node => ({
                age: (node.querySelector('.sibling-age')||{value:''}).value,
                state: (node.querySelector('.sibling-state')||{value:''}).value,
                died_age: (node.querySelector('.sibling-died-age')||{value:''}).value,
                died_year: (node.querySelector('.sibling-died-year')||{value:''}).value,
                died_cause: (node.querySelector('.sibling-died-cause')||{value:''}).value
            }));
            const children = Array.from(document.querySelectorAll('#children-repeater .child-item')).map(node => ({
                age: (node.querySelector('.child-age')||{value:''}).value,
                state: (node.querySelector('.child-state')||{value:''}).value,
                died_age: (node.querySelector('.child-died-age')||{value:''}).value,
                died_year: (node.querySelector('.child-died-year')||{value:''}).value,
                died_cause: (node.querySelector('.child-died-cause')||{value:''}).value
            }));
            return { brothers, sisters, children };
        }

        function loadRepeatersFromData(data = {}) {
            const bContainer = document.getElementById('brothers-repeater');
            const sContainer = document.getElementById('sisters-repeater');
            const cContainer = document.getElementById('children-repeater');
            bContainer.innerHTML = '';
            sContainer.innerHTML = '';
            cContainer.innerHTML = '';
            if (Array.isArray(data.brothers)) data.brothers.forEach((b, i) => bContainer.appendChild(createSiblingNode(b, 'Brother', i + 1)));
            if (Array.isArray(data.sisters)) data.sisters.forEach((s, i) => sContainer.appendChild(createSiblingNode(s, 'Sister', i + 1)));
            if (Array.isArray(data.children)) data.children.forEach((c, i) => cContainer.appendChild(createChildNode(c, 'Child', i + 1)));
            // update counts
            document.getElementById('num_brothers').value = (data.brothers && data.brothers.length) || 0;
            document.getElementById('num_sisters').value = (data.sisters && data.sisters.length) || 0;
            document.getElementById('num_children').value = (data.children && data.children.length) || 0;
            // renumber to ensure headers show correct ordinals
            renumberRepeaters('Brother');
            renumberRepeaters('Sister');
            renumberRepeaters('Child');
            // ensure delivery visibility updates when repeaters are loaded (children count may have changed)
            try { updateDeliveryVisibility(); } catch (e) { /* ignore */ }
        }

        // Expose functions for edit flow to call
        window.loadPreviousPoliciesIntoRepeater = loadPreviousPoliciesIntoRepeater;
        window.getPreviousPoliciesFromRepeater = getPreviousPoliciesFromRepeater;

        function closeRowDetails() {
            document.getElementById('row-details-modal').classList.add('hidden');
        }
        // expose for potential inline calls
        window.openRowDetails = openRowDetails;
        window.closeRowDetails = closeRowDetails;

        // --- Gemini Modal & Feature Functions ---
        function openModal(title) { /* ... identical ... */ }
        function closeModal() { /* ... identical ... */ }
        function showModalContent(content) { /* ... identical ... */ }
        async function generateSummary(index) { /* ... identical ... */ }


        // --- Event Listeners ---
        // (Event listeners for interactive buttons are attached inside DOMContentLoaded
        // to ensure the elements exist before we bind handlers.)

        document.addEventListener('DOMContentLoaded', () => {
            initializeFormTabs();
            // Disable native HTML5 constraint validation so the browser doesn't
            // block the submit event with built-in validation (which tries to
            // focus hidden invalid controls and causes the "not focusable" error).
            const formEl = document.getElementById('data-form');
            if (formEl) formEl.noValidate = true;
            // Attach submit handler after DOM is ready
            try {
                document.getElementById('data-form').addEventListener('submit', function(event) {
                    event.preventDefault();
                    let allTabsValid = true;
                    let firstInvalidInput = null;
                    let firstInvalidTab = null;
                    for (let i = 0; i < formTabPanels.length; i++) {
                        const panel = formTabPanels[i];
                        panel.querySelectorAll('.error-message').forEach(err => err.textContent = '');
                        const inputs = panel.querySelectorAll('input[required], select[required], input[type="email"], input[type="tel"], input[min]');
                        inputs.forEach(input => {
                            let errorMessage = '';
                            if (input.required && !input.value.trim()) {
                                errorMessage = 'This field is required.';
                            } else if (input.type === 'email' && input.value && !/^\S+@\S+\.\S+$/.test(input.value)) {
                                errorMessage = 'Please enter a valid email address.';
                            } else if (input.type === 'tel' && input.required && input.value && input.pattern && !new RegExp(input.pattern).test(input.value)) {
                                errorMessage = input.title || 'Please enter a valid 10-digit mobile number.';
                            } else if (input.type === 'number' && input.min !== '' && input.value !== '' && parseFloat(input.value) < parseFloat(input.min)) {
                                errorMessage = `Value cannot be less than ${input.min}.`;
                            } else if (input.id === 'aadhaar' && input.value && !/^\d{12}$/.test(input.value)) {
                                errorMessage = 'Aadhaar must be exactly 12 digits.';
                            } else if (input.id === 'pan' && input.value && !/^[A-Z]{5}\d{4}[A-Z]$/.test(input.value)) {
                                errorMessage = 'PAN must be in format: AAAAA9999A (5 letters, 4 digits, 1 letter).';
                            }

                            if (errorMessage) {
                                allTabsValid = false;
                                const errorSpan = input.parentElement.querySelector('.error-message');
                                if (errorSpan) errorSpan.textContent = errorMessage;
                                if (!firstInvalidInput) {
                                    firstInvalidInput = input;
                                    firstInvalidTab = i;
                                }
                            }
                        });
                    }

                    // validate nominee shares before finalizing
                    const nomineeSharesValid = validateNomineeShares();
                    if (!nomineeSharesValid) {
                        allTabsValid = false;
                    }

                    if (allTabsValid) {
                        // Before collecting, sanitize income fields so stored values are plain numbers (no commas/₹)
                        ['a_income','ly_income1','ly_income2','ly_income3','husband_annual_income'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) {
                                const raw = stripFormatting(el.value);
                                el.value = raw; // put plain value into the input so FormData picks it up clean
                            }
                        });

                        const formData = new FormData(this);
                        // Ensure checkbox values are explicit so they're always saved (checked -> 'true', unchecked -> 'false')
                        try {
                            const corrCheckboxEl = document.getElementById('corr_same_kyc');
                            if (corrCheckboxEl) formData.set('corr_same_kyc', corrCheckboxEl.checked ? 'true' : 'false');
                        } catch (e) { /* ignore */ }

                        const entry = {};
                        CSV_HEADERS.forEach(header => entry[header] = formData.get(header));
                        // collect repeater previous policies
                        try {
                            entry.previous_policies = getPreviousPoliciesFromRepeater();
                        } catch (e) { entry.previous_policies = []; }
                        // collect nominees repeater
                        try {
                            entry.nominees = getNomineesFromRepeater();
                        } catch (e) { entry.nominees = []; }
                        // collect siblings & children repeaters
                        try {
                            const rep = getRepeatersData();
                            entry.fam_brothers = JSON.stringify(rep.brothers || []);
                            entry.fam_sisters = JSON.stringify(rep.sisters || []);
                            entry.fam_children = JSON.stringify(rep.children || []);
                        } catch (e) { entry.fam_brothers = entry.fam_sisters = entry.fam_children = '[]'; }
                        const allData = getStoredData();
                        if (editingIndex !== null && editingIndex >= 0 && editingIndex < allData.length) {
                            // Update existing row
                            allData[editingIndex] = entry;
                        } else {
                            // New entry
                            allData.push(entry);
                        }
                        localStorage.setItem('formData', JSON.stringify(allData));
                        // Reset editing state
                        editingIndex = null;
                        this.reset();
                        // After reset, reformat any empty income displays if necessary (they're blank now)
                        ['a_income','ly_income1','ly_income2','ly_income3','husband_annual_income'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.value = '';
                        });
                        // ensure husband occupation cleared too
                        const husbandOccEl = document.getElementById('husband_occupation');
                        if (husbandOccEl) husbandOccEl.value = '';
                        alert('Data saved successfully!');
                        showMainTab('data-view');
                    } else {
                        alert('Please fill all mandatory fields before submitting.');
                        if (firstInvalidTab !== null) {
                            showFormTab(firstInvalidTab);
                            if (firstInvalidInput) {
                                setTimeout(() => {
                                    firstInvalidInput.focus();
                                    firstInvalidInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 100);
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to attach submit handler:', e);
            }
            // Attach other control listeners now that elements exist


            const clearBtn = document.getElementById('clear-data');
            if (clearBtn) clearBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete all submitted data? This action cannot be undone.')) {
                    localStorage.removeItem('formData');
                    renderDataTable();
                    alert('All data has been cleared.');
                }
            });

            const copyBtn = document.getElementById('copy-button');
            if (copyBtn) copyBtn.addEventListener('click', () => {
                const content = document.getElementById('modal-body').innerText;
                navigator.clipboard.writeText(content).then(() => {
                    alert('Copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = content;
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('Copied to clipboard!');
                    } catch (e) {
                        alert('Failed to copy text. Please copy it manually.');
                    }
                });
            });
            // (renderDataTable is defined at top-level)
            // Wire Add Previous Policy button
            const addPrevBtn = document.getElementById('add-previous-policy');
            if (addPrevBtn) addPrevBtn.addEventListener('click', () => {
                const container = document.getElementById('previous-policies-repeater');
                if (!container) return;
                container.appendChild(createPreviousPolicyNode());
            });
            // ensure repeater is present (no items) on load
            clearPreviousPoliciesRepeater();
            // Wire Add Nominee button
            const addNomBtn = document.getElementById('add-nominee');
            if (addNomBtn) addNomBtn.addEventListener('click', () => {
                const container = document.getElementById('nominees-repeater');
                if (!container) return;
                container.appendChild(createNomineeNode());
            });
            // ensure nominees repeater empty on load
            clearNomineesRepeater();
            // Wire DOB -> Age calculated field
            const dobInput = document.getElementById('dob');
            if (dobInput) {
                // update on change and input for instant feedback
                dobInput.addEventListener('change', (e) => updateAgeFieldFromDOB(e.target.value));
                dobInput.addEventListener('input', (e) => updateAgeFieldFromDOB(e.target.value));
                // If form already has a DOB (e.g., when returning to edit), calculate age now
                if (dobInput.value) updateAgeFieldFromDOB(dobInput.value);
            }
            // Wire search input
            document.getElementById('search-input').addEventListener('input', filterDataTable);

            // Wire income formatting listeners
            ['a_income','ly_income1','ly_income2','ly_income3','husband_annual_income'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                // format on blur
                el.addEventListener('blur', (e) => {
                    const raw = stripFormatting(e.target.value);
                    e.target.value = raw ? formatIndianNumber(raw) : '';
                });
                // remove formatting on focus so user can edit easily
                el.addEventListener('focus', (e) => {
                    const raw = stripFormatting(e.target.value);
                    e.target.value = raw;
                    // select all for convenience
                    try { e.target.select(); } catch (err) { /* ignore */ }
                });
                // while typing, allow only digits, dot and comma gets removed by formatting on blur
                el.addEventListener('input', (e) => {
                    // remove any non-numeric except dot and minus
                    const cleaned = e.target.value.replace(/[^0-9.-]/g, '');
                    if (cleaned !== e.target.value) e.target.value = cleaned;
                });
                // If value exists already (e.g., page load), format it for display
                if (el.value) {
                    el.value = formatIndianNumber(stripFormatting(el.value));
                }
            });
            // Wire Is Married -> show/hide spouse & date fields
            const isMarriedEl = document.getElementById('is_married');
            if (isMarriedEl) {
                isMarriedEl.addEventListener('change', (e) => updateMarriageDependentVisibility(e.target.value));
                // initialize visibility based on any pre-filled value
                if (isMarriedEl.value) updateMarriageDependentVisibility(isMarriedEl.value);
            }
            // Wire Gender -> show/hide pregnancy fields for Female
            const genderEl = document.getElementById('gender');
            if (genderEl) {
                genderEl.addEventListener('change', (e) => updatePregnancyVisibility(e.target.value));
                // initialize based on any pre-filled value
                if (genderEl.value) updatePregnancyVisibility(genderEl.value);
            }
            // Wire family state of health -> show/hide death detail containers for parents, spouse, siblings, children
            const mapRoles = [
                {id:'fam_father_state', role:'father'},
                {id:'fam_mother_state', role:'mother'},
                {id:'fam_spouse_state', role:'spouse'},
                {id:'fam_brother_state', role:'brother'},
                {id:'fam_sister_state', role:'sister'},
                {id:'fam_child_state', role:'child'}
            ];
            mapRoles.forEach(m => {
                const el = document.getElementById(m.id);
                if (!el) return;
                el.addEventListener('change', (e) => updateParentDeathVisibility(m.role, e.target.value));
                if (el.value) updateParentDeathVisibility(m.role, el.value);
            });
            // Wire number inputs to sync repeaters
            ['num_brothers','num_sisters','num_children'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('change', () => {
                    syncRepeatersFromCounts();
                    // if children count changed, update delivery visibility
                    if (id === 'num_children') try { updateDeliveryVisibility(); } catch (e) { /* ignore */ }
                });
            });
            // initialize repeaters on load
            try { syncRepeatersFromCounts(); } catch (e) { /* ignore */ }
            // Wire Dating Back -> show/hide dating_back_date
            const datingBackEl = document.getElementById('dating_back');
            if (datingBackEl) {
                datingBackEl.addEventListener('change', (e) => updateDatingBackVisibility(e.target.value));
                // initialize visibility based on any pre-filled value
                if (datingBackEl.value) updateDatingBackVisibility(datingBackEl.value);
            }
            // Wire Any Operations -> show/hide operation details
            const anyOpsEl = document.getElementById('any_operations');
            if (anyOpsEl) {
                anyOpsEl.addEventListener('change', (e) => updateOperationsVisibility(e.target.value));
                if (anyOpsEl.value) updateOperationsVisibility(anyOpsEl.value);
            }
            // Wire Any Diseases -> show/hide disease details
            const anyDisEl = document.getElementById('any_diseases');
            if (anyDisEl) {
                anyDisEl.addEventListener('change', (e) => updateDiseasesVisibility(e.target.value));
                if (anyDisEl.value) updateDiseasesVisibility(anyDisEl.value);
            }
            // Wire Correspondence address checkbox
            const corrCheckbox = document.getElementById('corr_same_kyc');
            const corrContainer = document.getElementById('corr-address-container');
            const corrAddressInput = document.getElementById('corr_address');
            const kycAddressInput = document.getElementById('address');
            if (corrCheckbox) {
                function updateCorrAddressVisibility() {
                    if (corrCheckbox.checked) {
                        if (corrContainer) corrContainer.classList.add('hidden');
                        if (corrAddressInput && kycAddressInput) corrAddressInput.value = kycAddressInput.value || '';
                    } else {
                        if (corrContainer) corrContainer.classList.remove('hidden');
                    }
                }
                // copy value when checkbox changes
                corrCheckbox.addEventListener('change', updateCorrAddressVisibility);
                // keep correspondence in sync if KYC address changes while checked
                if (kycAddressInput) kycAddressInput.addEventListener('input', () => {
                    if (corrCheckbox.checked && corrAddressInput && kycAddressInput) corrAddressInput.value = kycAddressInput.value || '';
                });
                // initialize state
                updateCorrAddressVisibility();
            }
            // Ensure delivery visibility reflects current state on load
            try { updateDeliveryVisibility(); } catch (e) { /* ignore */ }

            // Keyboard navigation for form tabs (Ctrl + Left/Right)
            document.addEventListener('keydown', (e) => {
                if (document.getElementById('form-view').classList.contains('hidden')) return; // only in form view
                if (e.key === 'ArrowLeft' && e.ctrlKey) {
                    e.preventDefault();
                    navigateFormTab(-1);
                } else if (e.key === 'ArrowRight' && e.ctrlKey) {
                    e.preventDefault();
                    navigateFormTab(1);
                }
            });
        function openModal(title) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = `<div class="flex items-center justify-center h-32"><div class="loader"></div></div>`;
            const gm = document.getElementById('gemini-modal');
            gm.classList.remove('hidden');
            try { const content = gm.querySelector('.modal-content'); scrollElementToTop(content); const body = document.getElementById('modal-body'); if (body) scrollElementToTop(body); } catch (e) { /* ignore */ }
        }
        function closeModal() {
            document.getElementById('gemini-modal').classList.add('hidden');
        }
        // Convert plaintext AI output into simple HTML (paragraphs, headings, unordered/ordered lists)
        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatAIContentToHTML(text) {
            if (!text) return '';
            const lines = String(text).replace(/\r/g, '').split('\n');
            let html = '';
            let inUl = false;
            let inOl = false;
            let inPara = false;

            const flushPara = () => {
                if (inPara) { html += '</p>'; inPara = false; }
            };
            const closeLists = () => {
                if (inUl) { html += '</ul>'; inUl = false; }
                if (inOl) { html += '</ol>'; inOl = false; }
            };

            for (let rawLine of lines) {
                const line = rawLine.trim();
                if (line === '') {
                    // paragraph break
                    flushPara();
                    closeLists();
                    continue;
                }

                // unordered list (- or * at line start)
                const ulMatch = line.match(/^[-*]\s+(.*)/);
                if (ulMatch) {
                    closeLists();
                    if (!inUl) { html += '<ul class="list-disc pl-6 mb-2">'; inUl = true; }
                    html += '<li>' + escapeHtml(ulMatch[1]) + '</li>';
                    continue;
                }

                // ordered list (1. 2. ...)
                const olMatch = line.match(/^\d+[.)]\s+(.*)/);
                if (olMatch) {
                    closeLists();
                    if (!inOl) { html += '<ol class="list-decimal pl-6 mb-2">'; inOl = true; }
                    html += '<li>' + escapeHtml(olMatch[1]) + '</li>';
                    continue;
                }

                // heading style: lines that end with ':' or are short and all-caps-like
                if (line.endsWith(':') || /^[A-Z0-9 \-]{3,60}:$/.test(line)) {
                    flushPara(); closeLists();
                    const h = escapeHtml(line.replace(/:$/, ''));
                    html += `<h3 class="text-lg font-semibold text-gray-800 mt-3 mb-1">${h}</h3>`;
                    continue;
                }

                // normal paragraph text
                closeLists();
                if (!inPara) { html += '<p class="mb-2">'; inPara = true; }
                else html += ' ';
                html += escapeHtml(line);
            }

            // close any open blocks
            if (inPara) html += '</p>';
            if (inUl) html += '</ul>';
            if (inOl) html += '</ol>';

            // Wrap in a container with readable styles
            return `<div class="prose max-w-none text-gray-700">${html}</div>`;
        }

        function showModalContent(content) {
            // If content already contains HTML tags from the AI, prefer to escape and format it safely.
            // Use the formatter to produce nicer, semantic HTML from plain text.
            const html = formatAIContentToHTML(content);
            document.getElementById('modal-body').innerHTML = html;
            try { const gm = document.getElementById('gemini-modal'); const contentEl = gm.querySelector('.modal-content'); scrollElementToTop(contentEl); const body = document.getElementById('modal-body'); if (body) scrollElementToTop(body); } catch (e) { /* ignore */ }
        }
        async function generateSummary(index) {
            if (!API_KEY || API_KEY.trim() === '') {
                alert('AI summary requires a valid Gemini API key. Please configure the API_KEY variable in the code.');
                return;
            }
            try {
                openModal('Generating Client Summary...');
                const rowData = getStoredData()[index];
                const prompt = `Act as a professional insurance agent. Based on the following data, write a concise summary for an internal client file. Focus on the key details like name, age, profession, proposed policy, sum assured, premium, and nominee.\nData: ${JSON.stringify(rowData)}`;
                const summary = await callGeminiAPI(prompt);
                showModalContent(summary);
            } catch (err) {
                console.error('generateSummary failed', err);
                showModalContent('Error generating summary: ' + (err && err.message ? err.message : String(err)));
            }
        }
        // Expose modal helpers and generateSummary globally so inline onclick handlers can call them
        try {
            window.generateSummary = generateSummary;
            window.openModal = openModal;
            window.closeModal = closeModal;
            window.showModalContent = showModalContent;
        } catch (e) { /* ignore in constrained environments */ }
        
        // Edit a stored row: populate the form and switch to the first tab
        function _editRow(index) {
            const allData = getStoredData();
            const row = allData[index];
            if (!row) return alert('Row not found');

            // Track that we're editing this row so submit will update instead of append
            editingIndex = index;

            // Populate fields using name attributes
            CSV_HEADERS.forEach(key => {
                const el = document.querySelector(`[name="${key}"]`);
                if (!el) return;
                // For income fields, format for display
                try {
                    if (['a_income','ly_income1','ly_income2','ly_income3','husband_annual_income'].includes(key)) {
                        el.value = row[key] ? formatIndianNumber(stripFormatting(row[key])) : '';
                    } else {
                        el.value = row[key] || '';
                    }
                } catch (e) { /* ignore */ }
            });

            // Ensure Dating Back visibility reflects loaded data (if any)
            try {
                const savedDating = row['dating_back'];
                if (typeof savedDating !== 'undefined' && savedDating !== null) updateDatingBackVisibility(savedDating);
                // if there's a stored date, populate it explicitly
                const dbDateEl = document.getElementById('dating_back_date');
                if (dbDateEl) dbDateEl.value = row['dating_back_date'] || '';
            } catch (e) { /* ignore */ }

            // Ensure pregnancy visibility reflects loaded data
            try {
                const gval = row['gender'] || (document.getElementById('gender') ? document.getElementById('gender').value : '');
                if (gval) updatePregnancyVisibility(gval);
                // restore values if present
                const pregEl = document.getElementById('are_pregnant');
                if (pregEl) pregEl.value = row['are_pregnant'] || '';
                const ldEl = document.getElementById('last_delivery_date');
                if (ldEl) ldEl.value = row['last_delivery_date'] || '';
                // Ensure delivery visibility honors loaded number of children and gender
                try { updateDeliveryVisibility(); } catch (e) { /* ignore */ }
            } catch (e) { /* ignore */ }

            // Re-apply last_delivery_date after repeaters/visibility updates in case updateDeliveryVisibility cleared it
            try {
                const ldElPost = document.getElementById('last_delivery_date');
                if (ldElPost) {
                    // If there is a saved value, restore it
                    if (row['last_delivery_date']) ldElPost.value = row['last_delivery_date'];
                    // Ensure required attribute matches current visibility (container may have been toggled)
                    const lastDelContainer = document.getElementById('last-delivery-container');
                    if (lastDelContainer && !lastDelContainer.classList.contains('hidden')) {
                        ldElPost.setAttribute('required', 'required');
                    } else {
                        ldElPost.removeAttribute('required');
                    }
                }
            } catch (e) { /* ignore */ }

            // Ensure family death visibility reflects loaded data (parents, spouse, siblings, children)
            try {
                const roles = ['father','mother','spouse','brother','sister','child'];
                roles.forEach(r => {
                    const key = `fam_${r}_state`;
                    const saved = row[key] || (document.getElementById(key) ? document.getElementById(key).value : '');
                    if (typeof saved !== 'undefined' && saved !== null) updateParentDeathVisibility(r, saved);
                });
                // load repeaters if saved
                try {
                    const rep = {
                        brothers: Array.isArray(row.fam_brothers) ? row.fam_brothers : (row.fam_brothers ? JSON.parse(row.fam_brothers) : []),
                        sisters: Array.isArray(row.fam_sisters) ? row.fam_sisters : (row.fam_sisters ? JSON.parse(row.fam_sisters) : []),
                        children: Array.isArray(row.fam_children) ? row.fam_children : (row.fam_children ? JSON.parse(row.fam_children) : [])
                    };
                    loadRepeatersFromData(rep);
                } catch (e) { /* ignore */ }
            } catch (e) { /* ignore */ }

            // Populate previous policies repeater (if any)
            try {
                if (row.previous_policies && Array.isArray(row.previous_policies)) {
                    loadPreviousPoliciesIntoRepeater(row.previous_policies);
                } else {
                    // If legacy single prev_policy fields exist, load the single legacy entry into repeater
                    const legacy = { prev_policy_no: row.prev_policy_no || '', prev_plan_term: row.prev_plan_term || '', prev_y_premium: row.prev_y_premium || '' };
                    if (legacy.prev_policy_no || legacy.prev_plan_term || legacy.prev_y_premium) loadPreviousPoliciesIntoRepeater([legacy]);
                    else clearPreviousPoliciesRepeater();
                }
            } catch (e) { clearPreviousPoliciesRepeater(); }

            // Populate nominees repeater (if any)
            try {
                if (row.nominees && Array.isArray(row.nominees)) {
                    loadNomineesIntoRepeater(row.nominees);
                } else {
                    clearNomineesRepeater();
                }
            } catch (e) { clearNomineesRepeater(); }

            // Restore correspondence checkbox and field visibility/value based on saved row
            try {
                const corrCheckbox = document.getElementById('corr_same_kyc');
                const corrContainer = document.getElementById('corr-address-container');
                const corrAddressInput = document.getElementById('corr_address');
                const kycAddressInput = document.getElementById('address');
                const savedCorr = row['corr_same_kyc'];
                if (corrCheckbox) {
                    corrCheckbox.checked = (savedCorr === 'on' || savedCorr === 'true' || savedCorr === '1');
                }
                if (corrCheckbox && corrCheckbox.checked) {
                    if (corrContainer) corrContainer.classList.add('hidden');
                    if (corrAddressInput) corrAddressInput.value = row['corr_address'] || (row['address'] || '');
                } else {
                    if (corrContainer) corrContainer.classList.remove('hidden');
                    if (corrAddressInput) corrAddressInput.value = row['corr_address'] || '';
                }
            } catch (e) { /* ignore */ }

            // Show form view and go to first tab
            showMainTab('form-view');
            showFormTab(0);

            // Focus first input in first tab
            const firstInput = formTabPanels[0].querySelector('input, select, textarea');
            if (firstInput) setTimeout(() => { firstInput.focus(); firstInput.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 120);
            // If DOB exists on the loaded row, update the calculated age field
            try { if (row.dob) updateAgeFieldFromDOB(row.dob); } catch (e) { /* ignore */ }
            // Ensure marriage-dependent visibility reflects loaded data
            try { const mval = document.getElementById('is_married') ? document.getElementById('is_married').value : ''; if (mval) updateMarriageDependentVisibility(mval); } catch (e) { /* ignore */ }
            // Ensure operations/diseases visibility reflects loaded data
            try { const opval = document.getElementById('any_operations') ? document.getElementById('any_operations').value : ''; if (opval) updateOperationsVisibility(opval); } catch (e) { /* ignore */ }
            try { const dval = document.getElementById('any_diseases') ? document.getElementById('any_diseases').value : ''; if (dval) updateDiseasesVisibility(dval); } catch (e) { /* ignore */ }
        }
        // Expose editRow globally so inline onclick handlers can call it
        window.editRow = _editRow;
        // Delete a stored row by index
        function _deleteRow(index) {
            const allData = getStoredData();
            if (!allData[index]) return alert('Row not found.');
            if (!confirm('Are you sure you want to delete this row? This action cannot be undone.')) return;
            allData.splice(index, 1);
            localStorage.setItem('formData', JSON.stringify(allData));
            // If we were editing this row, clear editing state
            if (editingIndex !== null) {
                if (editingIndex === index) editingIndex = null;
                else if (editingIndex > index) editingIndex -= 1; // shift down
            }
            renderDataTable();
        }
        window.deleteRow = _deleteRow;
         
// Improved Export/Import Functions for better data integrity

function exportDataAsJSON() {
    const allData = getStoredData();
    if (allData.length === 0) {
        alert('No data to export.');
        return;
    }

    const jsonData = {
        exportDate: new Date().toISOString(),
        version: "1.0",
        data: allData
    };

    const jsonString = JSON.stringify(jsonData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `insurance_form_data_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(url);
}

function importDataFromJSON(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonData = JSON.parse(e.target.result);

            // Validate the JSON structure
            if (!jsonData.data || !Array.isArray(jsonData.data)) {
                alert('Invalid file format. Please select a valid export file.');
                return;
            }

            // Merge with existing data or replace (user choice)
            const existingData = getStoredData();
            let importChoice = 'replace';

            if (existingData.length > 0) {
                importChoice = confirm(
                    `You have ${existingData.length} existing record(s).\n` +
                    `Click OK to ADD the imported data to existing records,\n` +
                    `or Cancel to REPLACE all existing data.`
                ) ? 'add' : 'replace';
            }

            let finalData;
            if (importChoice === 'add') {
                finalData = [...existingData, ...jsonData.data];
            } else {
                finalData = jsonData.data;
            }

            // Save the data
            localStorage.setItem('formData', JSON.stringify(finalData));

            // Refresh the display
            renderDataTable();

            alert(`Successfully imported ${jsonData.data.length} record(s).`);

        } catch (error) {
            alert('Error importing file: ' + error.message);
        }
    };

    reader.readAsText(file);
}








        
        // New Export/Import Event Listeners
        document.getElementById('export-json').addEventListener('click', function() {
            exportDataAsJSON();
        });

        document.getElementById('import-json').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                importDataFromJSON(file);
                e.target.value = ''; // Clear the input
            }
        });



        document.getElementById('copy-button').addEventListener('click', () => {
             const content = document.getElementById('modal-body').innerText;
             navigator.clipboard.writeText(content).then(() => {
                 alert('Copied to clipboard!');
             }).catch(err => {
                console.error('Failed to copy text: ', err);
                // Fallback for older browsers
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = content;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Copied to clipboard!');
                } catch (e) {
                    alert('Failed to copy text. Please copy it manually.');
                }
             });
        });
        });

    </script>
</body>
</html>
